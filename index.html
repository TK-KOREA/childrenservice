<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•ˆì–‘êµíšŒ ìœ ì´ˆë“±ë¶€ ì¼ì •</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --day-height-mobile: 90px; 
            --day-height-tablet: 110px;
            --day-height-pc: 150px;
            --date-font-size: 0.95rem; 
            --event-font-size: 10px; 
        }

        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #fdfcf8; 
            color: #1e293b;
            scroll-behavior: smooth;
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden;
            margin: 0;
        }

        #calendarViewport { position: relative; width: 100%; overflow: hidden; min-height: 420px; }
        #calendarStrip { display: flex; width: 300%; transform: translateX(-33.3333%); will-change: transform; }
        .month-view { width: 33.3333%; display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; align-content: start; }
        
        .sliding-transition { transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }

        .calendar-day { 
            height: var(--day-height-mobile); 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start; 
            padding: 0.2rem 0.05rem; border: 1px solid #f1f5f9; 
            background: white; overflow: hidden; cursor: pointer;
        }
        @media (min-width: 768px) { .calendar-day { height: var(--day-height-tablet); } }
        @media (min-width: 1024px) { .calendar-day { height: var(--day-height-pc); padding: 0.5rem 0.15rem; } }

        .calendar-day:hover { background-color: #fffaf5; }
        .calendar-day.selected-day { border-color: #fb923c; background-color: #fff7ed; box-shadow: inset 0 0 0 1px #fb923c; }

        .event-container { width: 100%; flex: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center; scrollbar-width: none; }
        .event-container::-webkit-scrollbar { display: none; }
        .date-label { font-size: var(--date-font-size); font-weight: 900; flex-shrink: 0; margin-bottom: 2px; }
        
        .event-bar { 
            font-size: var(--event-font-size); padding: 2px 1px; border-radius: 3px; margin-top: 2px; 
            width: 98%; white-space: nowrap; overflow: hidden; text-overflow: clip; 
            font-weight: 700; text-align: left; border-width: 1.5px; line-height: 1.1; flex-shrink: 0; letter-spacing: -0.06em;
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }

        .holiday-label { font-size: 8px; color: #ef4444; margin-top: -2px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: clip; max-width: 90%; }
        
        .ribbon-enter { animation: ribbonIn 0.3s ease-out forwards; }
        @keyframes ribbonIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .search-container { display: flex; align-items: center; background: #f1f5f9; border-radius: 9999px; padding: 0.2rem 0.6rem; width: 120px; }
        
        #statusIndicator { height: 2px; width: 0%; background: #fb923c; position: fixed; top: 0; left: 0; z-index: 100; transition: width 0.3s; }

        /* ìƒì„¸ ë‚´ì—­ ìŠ¤íƒ€ì¼ */
        .info-card { background: white; border-radius: 20px; border: 1px solid #f1f5f9; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        .tag { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 800; }
        .tag-red { background: #fef2f2; color: #ef4444; border: 1px solid #fee2e2; }
        .tag-blue { background: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; }
        .tag-green { background: #f0fdf4; color: #22c55e; border: 1px solid #dcfce7; }
    </style>
</head>
<body>

    <div id="statusIndicator"></div>

    <nav class="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-orange-100 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
            <div id="navTitle" class="text-lg md:text-2xl font-black tracking-tighter">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="ê²€ìƒ‰" class="bg-transparent border-none outline-none text-xs font-bold w-full">
                <button onclick="handleSearch()" class="text-slate-400">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-[99%] mx-auto pb-4 pt-2 md:pt-6">
        <section id="schedule">
            <div id="calendarContainer" class="section-card p-1 md:p-6 bg-white rounded-2xl shadow-lg border border-slate-100">
                <div class="flex justify-between items-center mb-3 px-1">
                    <button id="prevMonth" class="p-2 text-slate-300 hover:text-orange-500 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <button onclick="goToToday()" class="text-[10px] font-black text-orange-600 bg-orange-50 px-4 py-1.5 rounded-full border border-orange-100 uppercase tracking-tighter active:scale-95 transition-transform">Today</button>
                    <button id="nextMonth" class="p-2 text-slate-300 hover:text-orange-500 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>

                <div class="grid grid-cols-7 gap-1 text-center mb-1 border-b border-slate-50 pb-2">
                    <div class="text-red-400 font-black text-[10px] md:text-xs">ì£¼ì¼</div>
                    <div class="text-slate-300 font-black text-[10px] md:text-xs">ì›”</div>
                    <div class="text-slate-300 font-black text-[10px] md:text-xs">í™”</div>
                    <div class="text-slate-300 font-black text-[10px] md:text-xs">ìˆ˜</div>
                    <div class="text-slate-300 font-black text-[10px] md:text-xs">ëª©</div>
                    <div class="text-slate-300 font-black text-[10px] md:text-xs">ê¸ˆ</div>
                    <div class="text-blue-400 font-black text-[10px] md:text-xs">í† </div>
                </div>

                <div id="calendarViewport">
                    <div id="calendarStrip">
                        <div id="prevGrid" class="month-view"></div>
                        <div id="currGrid" class="month-view"></div>
                        <div id="nextGrid" class="month-view"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="detailRibbonSection" class="max-w-6xl mx-auto mt-6 px-2 md:px-0 scroll-mt-20">
            <div id="ribbonContent" class="space-y-4"></div>
        </section>
    </main>

    <div class="max-w-xl mx-auto px-6 py-10 text-center border-t border-slate-100 opacity-50">
        <button onclick="openInstallModal()" class="text-xs font-bold text-slate-400 underline mb-4">í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê¸°</button>
        <p class="text-[9px] font-medium tracking-widest uppercase">Â© 2026 ANYANG CHURCH CHILDREN MINISTRY.</p>
    </div>

    <!-- ëª¨ë‹¬ -->
    <div id="modalOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg relative overflow-hidden transform transition-all p-6 md:p-10 z-10">
            <div id="modalContent" class="max-h-[70vh] overflow-y-auto"></div>
            <button onclick="closeModal()" class="mt-6 w-full py-3 bg-slate-100 rounded-xl font-bold text-slate-500">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        const SHEET_ID = '18zGuXQQWPm_dM2W6xD2Ugysaiz-sukIFJByO_TZrFy0'; 
        const HOLIDAY_ICS_URL = 'https://calendar.google.com/calendar/ical/ko.south_korea%23holiday%40group.v.google.com/public/basic.ics';
        
        let events = []; 
        let holidays = {
            "2025-01-01": "ì‹ ì •", "2025-01-28": "ì„¤ë‚ ", "2025-01-29": "ì„¤ë‚ ", "2025-01-30": "ì„¤ë‚ ", "2025-03-01": "ì‚¼ì¼ì ˆ", "2025-03-03": "ëŒ€ì²´ê³µíœ´ì¼", "2025-05-05": "ì–´ë¦°ì´ë‚ ", "2025-06-06": "í˜„ì¶©ì¼", "2025-08-15": "ê´‘ë³µì ˆ", "2025-10-03": "ê°œì²œì ˆ", "2025-10-05": "ì¶”ì„", "2025-10-09": "í•œê¸€ë‚ ", "2025-12-25": "ì„±íƒ„ì ˆ",
            "2026-01-01": "ì‹ ì •", "2026-02-16": "ì„¤ë‚ ", "2026-02-17": "ì„¤ë‚ ", "2026-02-18": "ì„¤ë‚ ", "2026-03-01": "ì‚¼ì¼ì ˆ", "2026-03-02": "ëŒ€ì²´ê³µíœ´ì¼", "2026-05-05": "ì–´ë¦°ì´ë‚ ", "2026-05-24": "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ", "2026-10-09": "í•œê¸€ë‚ ", "2026-12-25": "ì„±íƒ„ì ˆ"
        };

        const todayObj = new Date();
        let currentDate = new Date(todayObj.getFullYear(), todayObj.getMonth(), 1); 
        const WEEK_NAMES = ['ì£¼ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];

        const strip = document.getElementById('calendarStrip');
        const indicator = document.getElementById('statusIndicator');

        function fastRender() {
            document.getElementById('navTitle').innerHTML = `${currentDate.getFullYear()}ë…„ <span class="text-orange-500">${currentDate.getMonth() + 1}ì›”</span>`;
            document.getElementById('prevGrid').innerHTML = generateMonthHtml(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            document.getElementById('currGrid').innerHTML = generateMonthHtml(currentDate);
            document.getElementById('nextGrid').innerHTML = generateMonthHtml(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
        }

        async function fetchEvents() {
            indicator.style.width = '30%';
            try {
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&t=${Date.now()}`);
                const text = await res.text();
                const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
                events = json.table.rows.map((r, idx) => {
                    const c = r.c;
                    if (!c || !c[0]) return null;
                    return {
                        id: idx,
                        start: parseGoogleDate(c[0]?.v),
                        end: parseGoogleDate(c[1]?.v),
                        startTime: c[2]?.f || c[2]?.v || "",
                        endTime: c[3]?.f || c[3]?.v || "",
                        meetingType: c[4]?.v || "ê¸°íƒ€",
                        leader: c[5]?.v || "-", 
                        speaker: c[6]?.v || "-", 
                        division: c[7]?.v || "-", 
                        mealPrep: c[8]?.v || "-", 
                        menu: c[10]?.v || "-", 
                        wash: c[11]?.v || "-",
                        subject: c[12]?.v || "", 
                        note: c[13]?.v || ""
                    };
                }).filter(e => e !== null);
                indicator.style.width = '100%';
                fastRender();
                openDayInfo(todayObj.getFullYear(), todayObj.getMonth(), todayObj.getDate(), false);
                setTimeout(() => indicator.style.width = '0%', 400);
            } catch (e) { indicator.style.width = '0%'; }
        }

        function parseGoogleDate(v) {
            if (!v) return null;
            if (typeof v === 'string' && v.startsWith('Date')) {
                const m = v.match(/Date\((\d+),(\d+),(\d+)\)/);
                return m ? new Date(m[1], m[2], m[3]) : new Date(v);
            }
            return new Date(v);
        }

        function generateMonthHtml(date) {
            const y = date.getFullYear(), m = date.getMonth();
            const last = new Date(y, m+1, 0).getDate();
            const first = new Date(y, m, 1).getDay();
            let html = '';
            for(let i=0; i<first; i++) html += '<div></div>';
            for(let i=1; i<=last; i++) {
                const target = new Date(y, m, i);
                const hDate = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const holiday = holidays[hDate];
                const dayEvents = events.filter(e => {
                    if(!e.start) return false;
                    const s = new Date(e.start); s.setHours(0,0,0,0);
                    const end = e.end ? new Date(e.end) : new Date(e.start); end.setHours(23,59,59,999);
                    return target >= s && target <= end;
                });
                const isToday = (target.toDateString() === todayObj.toDateString());
                const color = (target.getDay() === 0 || holiday) ? 'text-red-500' : target.getDay() === 6 ? 'text-blue-500' : 'text-slate-800';
                const eventHtml = dayEvents.map(e => `<div class="event-bar border ${e.meetingType === 'ì£¼ì¼ì§‘íšŒ' ? 'bg-red-50 text-red-600 border-red-100' : e.meetingType === 'ì†Œê·¸ë£¹' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-green-50 text-green-600 border-green-100'}">${e.meetingType}</div>`).join('');
                
                html += `<div id="day-${y}-${m}-${i}" class="calendar-day" onclick="openDayInfo(${y}, ${m}, ${i}, false)"><div class="date-label ${isToday ? 'bg-orange-500 text-white rounded-full w-6 h-6 md:w-8 md:h-8 flex items-center justify-center shadow-md' : 'w-6 h-6 md:w-8 md:h-8 flex items-center justify-center ' + color}">${i}</div>${holiday ? `<div class="holiday-label">${holiday}</div>` : ''}<div class="event-container">${eventHtml}</div></div>`;
            }
            return html;
        }

        window.openDayInfo = (y, m, d, doScroll = true) => {
            document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected-day'));
            const selectedEl = document.getElementById(`day-${y}-${m}-${d}`);
            if(selectedEl) selectedEl.classList.add('selected-day');

            const target = new Date(y, m, d);
            const hDate = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const holiday = holidays[hDate];
            const dayEvents = events.filter(e => {
                const s = new Date(e.start); s.setHours(0,0,0,0);
                const end = e.end ? new Date(e.end) : new Date(e.start); end.setHours(23,59,59,999);
                return target >= s && target <= end;
            });

            let html = `<div class="flex items-center gap-3 mb-4 px-4 ribbon-enter"><span class="text-3xl font-black ${target.getDay() === 0 || holiday ? 'text-red-500' : 'text-slate-800'}">${d}</span><div class="text-sm font-bold text-slate-500"><div>${y}ë…„ ${m+1}ì›”</div><div>${WEEK_NAMES[target.getDay()]} ${holiday ? `<span class="text-red-400">| ${holiday}</span>` : ''}</div></div></div>`;

            if (dayEvents.length === 0) {
                html += `<div class="text-center py-10 bg-white rounded-3xl border border-slate-100 ribbon-enter"><p class="text-slate-300 font-bold">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
            } else {
                html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 ribbon-enter">`;
                dayEvents.forEach(e => {
                    const isMeeting = e.meetingType === 'ì£¼ì¼ì§‘íšŒ';
                    const isGroup = e.meetingType === 'ì†Œê·¸ë£¹';
                    const colorSet = isMeeting ? 'tag-red' : isGroup ? 'tag-blue' : 'tag-green';
                    
                    let specialInfo = '';
                    if (isMeeting) {
                        specialInfo = `
                            <div class="mt-4 pt-4 border-t border-slate-50 grid grid-cols-3 gap-2 text-center">
                                <div><p class="text-[9px] text-slate-400 mb-1 font-bold">ì§„í–‰</p><p class="text-xs font-black text-slate-700">${e.leader}</p></div>
                                <div><p class="text-[9px] text-slate-400 mb-1 font-bold">ë§ì”€</p><p class="text-xs font-black text-slate-700">${e.speaker}</p></div>
                                <div><p class="text-[9px] text-slate-400 mb-1 font-bold">ë¶„ë°˜</p><p class="text-xs font-black text-blue-600">${e.division}</p></div>
                            </div>`;
                    } else if (isGroup) {
                        specialInfo = `
                            <div class="mt-4 pt-4 border-t border-slate-50 space-y-3">
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-slate-400 font-bold">ì‹ì‚¬ì¤€ë¹„íŒ€</span>
                                    <span class="font-black text-slate-700">${e.mealPrep}</span>
                                </div>
                                <div class="bg-orange-50/50 p-3 rounded-xl text-center">
                                    <p class="text-[9px] text-orange-400 font-black mb-1 uppercase tracking-tighter">Today's Menu</p>
                                    <p class="text-sm font-black text-slate-800">ğŸ½ï¸ ${e.menu}</p>
                                </div>
                                <div class="flex justify-between items-center text-[10px]">
                                    <span class="text-slate-400 font-medium">ì„¤ê±°ì§€ ë´‰ì‚¬</span>
                                    <span class="font-bold text-slate-500">${e.wash}</span>
                                </div>
                            </div>`;
                    }

                    html += `
                        <div class="info-card p-6 relative overflow-hidden">
                            <div class="flex justify-between items-start mb-3">
                                <span class="tag ${colorSet}">${e.meetingType}</span>
                                <span class="text-[11px] font-bold text-slate-400 tracking-tight">${e.startTime} - ${e.endTime}</span>
                            </div>
                            <h3 class="text-lg font-black text-slate-800 mb-2 leading-tight">${e.subject || e.meetingType}</h3>
                            ${specialInfo}
                            ${e.note ? `<div class="mt-4 text-[11px] text-slate-400 bg-slate-50 p-2 rounded-lg leading-relaxed"><b>ë¹„ê³ :</b> ${e.note}</div>` : ''}
                        </div>`;
                });
                html += `</div>`;
            }
            document.getElementById('ribbonContent').innerHTML = html;
            if(doScroll) document.getElementById('detailRibbonSection').scrollIntoView({ behavior: 'smooth' });
        };

        function changeMonth(offset) {
            strip.classList.add('sliding-transition');
            strip.style.transform = `translateX(${offset > 0 ? -66.6666 : 0}%)`;
            setTimeout(() => {
                currentDate.setMonth(currentDate.getMonth() + offset);
                strip.classList.remove('sliding-transition');
                fastRender();
                strip.style.transform = `translateX(-33.3333%)`;
            }, 300);
        }

        window.handleSearch = () => {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            const res = events.filter(e => e.meetingType.includes(query) || e.subject.includes(query) || (e.note && e.note.includes(query)));
            let html = `<h2 class="text-lg font-black mb-4">'${query}' ê²€ìƒ‰ ê²°ê³¼</h2>`;
            if (res.length === 0) html += `<p class="py-6 text-slate-400 text-center text-sm">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            else res.forEach(e => {
                const d = new Date(e.start);
                html += `<div class="p-3 mb-2 bg-slate-50 rounded-xl cursor-pointer text-sm" onclick="closeModal(); setTimeout(()=> { currentDate = new Date(${d.getFullYear()}, ${d.getMonth()}, 1); fastRender(); openDayInfo(${d.getFullYear()}, ${d.getMonth()}, ${d.getDate()}, true); }, 100)"><div class="text-[9px] font-black text-orange-500">${d.getMonth()+1}ì›” ${d.getDate()}ì¼</div><div class="font-bold">${e.meetingType}: ${e.subject || ''}</div></div>`;
            });
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalOverlay').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('modalOverlay').classList.add('hidden');
        window.openInstallModal = () => {
            document.getElementById('modalContent').innerHTML = `<h3 class="text-lg font-black mb-4">í™ˆ í™”ë©´ ì¶”ê°€</h3><p class="text-sm text-slate-600 leading-relaxed"><b>iPhone:</b> ê³µìœ  ë²„íŠ¼ì„ ëˆ„ë¥´ê³  'í™ˆ í™”ë©´ì— ì¶”ê°€' ì„ íƒ<br><b>Android:</b> ì„¤ì •(ì 3ê°œ)ì„ ëˆ„ë¥´ê³  'í™ˆ í™”ë©´ì— ì¶”ê°€' ì„ íƒ</p>`;
            document.getElementById('modalOverlay').classList.remove('hidden');
        };

        let startX_pos = 0;
        document.getElementById('calendarViewport').addEventListener('touchstart', e => { startX_pos = e.touches[0].clientX; strip.classList.remove('sliding-transition'); }, {passive: true});
        document.getElementById('calendarViewport').addEventListener('touchmove', e => {
            const dx = e.touches[0].clientX - startX_pos;
            strip.style.transform = `translateX(${-33.3333 + (dx / window.innerWidth) * 33.3333}%)`;
        }, {passive: true});
        document.getElementById('calendarViewport').addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - startX_pos;
            if (Math.abs(dx) > 50) changeMonth(dx > 0 ? -1 : 1);
            else { strip.classList.add('sliding-transition'); strip.style.transform = `translateX(-33.3333%)`; }
        }, {passive: true});

        document.getElementById('prevMonth').onclick = () => changeMonth(-1);
        document.getElementById('nextMonth').onclick = () => changeMonth(1);
        window.goToToday = () => { currentDate = new Date(todayObj.getFullYear(), todayObj.getMonth(), 1); fastRender(); openDayInfo(todayObj.getFullYear(), todayObj.getMonth(), todayObj.getDate(), true); };

        fastRender();
        fetchEvents();
        setTimeout(async () => {
            try {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(HOLIDAY_ICS_URL)}&t=${Date.now()}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                const icsText = data.contents;
                const vevents = icsText.split('BEGIN:VEVENT');
                vevents.shift(); 
                vevents.forEach(vevent => {
                    const dMatch = vevent.match(/DTSTART(?:;VALUE=DATE)?:(\d{8})/);
                    const sMatch = vevent.match(/SUMMARY:(.*)/);
                    if (dMatch && sMatch) {
                        const ds = dMatch[1];
                        holidays[`${ds.substring(0, 4)}-${ds.substring(4, 6)}-${ds.substring(6, 8)}`] = sMatch[1].replace(/\r/g, '').replace(/\\,/g, ',').trim();
                    }
                });
                fastRender();
            } catch (e) {}
        }, 1000);
    </script>
</body>
</html>

            </div>
        </div>
    </nav>

    <main class="max-w-[99%] mx-auto pb-4 pt-2 md:pt-6">
        <section id="schedule">
            <div id="calendarContainer" class="section-card p-1 md:p-6 bg-white rounded-2xl shadow-lg border border-slate-100">
                <div class="flex justify-between items-center mb-3 px-1">
                    <button id="prevMonth" class="p-2 text-slate-300 hover:text-orange-500 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <button onclick="goToToday()" class="text-[10px] font-black text-orange-600 bg-orange-50 px-4 py-1.5 rounded-full border border-orange-100 uppercase tracking-tighter active:scale-95 transition-transform">Today</button>
                    <button id="nextMonth" class="p-2 text-slate-300 hover:text-orange-500 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>

                <div class="grid grid-cols-7 gap-1 text-center mb-1 border-b border-slate-50 pb-2">
                    <div class="text-red-400 font-black text-[10px] md:text-xs">ì£¼ì¼</div>
                    <div class="text-slate-300 font-black text-[10px] md:text-xs">ì›”</div>
                    <div class="text-slate-300 font-black text-[10px] md:text-xs">í™”</div>
                    <div class="text-slate-300 font-black text-[10px] md:text-xs">ìˆ˜</div>
                    <div class="text-slate-300 font-black text-[10px] md:text-xs">ëª©</div>
                    <div class="text-slate-300 font-black text-[10px] md:text-xs">ê¸ˆ</div>
                    <div class="text-blue-400 font-black text-[10px] md:text-xs">í† </div>
                </div>

                <div id="calendarViewport">
                    <div id="calendarStrip">
                        <div id="prevGrid" class="month-view"></div>
                        <div id="currGrid" class="month-view"></div>
                        <div id="nextGrid" class="month-view"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="detailRibbonSection" class="max-w-6xl mx-auto mt-6 px-2 md:px-0 scroll-mt-20">
            <div id="ribbonContent" class="space-y-4"></div>
        </section>
    </main>

    <div class="max-w-xl mx-auto px-6 py-10 text-center border-t border-slate-100 opacity-50">
        <button onclick="openInstallModal()" class="text-xs font-bold text-slate-400 underline mb-4">í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê¸°</button>
        <p class="text-[9px] font-medium tracking-widest uppercase">Â© 2026 ANYANG CHURCH CHILDREN MINISTRY.</p>
    </div>

    <!-- ê²€ìƒ‰/ì•Œë¦¼ ëª¨ë‹¬ -->
    <div id="modalOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg relative overflow-hidden transform transition-all p-6 md:p-10 z-10">
            <div id="modalContent" class="max-h-[70vh] overflow-y-auto"></div>
            <button onclick="closeModal()" class="mt-6 w-full py-3 bg-slate-100 rounded-xl font-bold text-slate-500">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        const SHEET_ID = '18zGuXQQWPm_dM2W6xD2Ugysaiz-sukIFJByO_TZrFy0'; 
        const HOLIDAY_ICS_URL = 'https://calendar.google.com/calendar/ical/ko.south_korea%23holiday%40group.v.google.com/public/basic.ics';
        
        let events = []; 
        let holidays = {
            "2025-01-01": "ì‹ ì •", "2025-01-28": "ì„¤ë‚ ", "2025-01-29": "ì„¤ë‚ ", "2025-01-30": "ì„¤ë‚ ", "2025-03-01": "ì‚¼ì¼ì ˆ", "2025-03-03": "ëŒ€ì²´ê³µíœ´ì¼", "2025-05-05": "ì–´ë¦°ì´ë‚ ", "2025-06-06": "í˜„ì¶©ì¼", "2025-08-15": "ê´‘ë³µì ˆ", "2025-10-03": "ê°œì²œì ˆ", "2025-10-05": "ì¶”ì„", "2025-10-09": "í•œê¸€ë‚ ", "2025-12-25": "ì„±íƒ„ì ˆ",
            "2026-01-01": "ì‹ ì •", "2026-02-16": "ì„¤ë‚ ", "2026-02-17": "ì„¤ë‚ ", "2026-02-18": "ì„¤ë‚ ", "2026-03-01": "ì‚¼ì¼ì ˆ", "2026-03-02": "ëŒ€ì²´ê³µíœ´ì¼", "2026-05-05": "ì–´ë¦°ì´ë‚ ", "2026-05-24": "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ", "2026-10-09": "í•œê¸€ë‚ ", "2026-12-25": "ì„±íƒ„ì ˆ"
        };

        const todayObj = new Date();
        let currentDate = new Date(todayObj.getFullYear(), todayObj.getMonth(), 1); 
        const WEEK_NAMES = ['ì£¼ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];

        const strip = document.getElementById('calendarStrip');
        const indicator = document.getElementById('statusIndicator');

        // ì¦‰ì‹œ ë Œë”ë§
        function fastRender() {
            document.getElementById('navTitle').innerHTML = `${currentDate.getFullYear()}ë…„ <span class="text-orange-500">${currentDate.getMonth() + 1}ì›”</span>`;
            document.getElementById('prevGrid').innerHTML = generateMonthHtml(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            document.getElementById('currGrid').innerHTML = generateMonthHtml(currentDate);
            document.getElementById('nextGrid').innerHTML = generateMonthHtml(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
        }

        // êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° (ë¹„ë™ê¸°)
        async function fetchEvents() {
            indicator.style.width = '30%';
            try {
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&t=${Date.now()}`);
                const text = await res.text();
                const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
                events = json.table.rows.map((r, idx) => {
                    const c = r.c;
                    if (!c || !c[0]) return null;
                    return {
                        id: idx,
                        start: parseGoogleDate(c[0]?.v),
                        end: parseGoogleDate(c[1]?.v),
                        startTime: c[2]?.f || c[2]?.v || "",
                        endTime: c[3]?.f || c[3]?.v || "",
                        meetingType: c[4]?.v || "ê¸°íƒ€",
                        leader: c[5]?.v || "-", speaker: c[6]?.v || "-", division: c[7]?.v || "-", mealPrep: c[8]?.v || "-", menu: c[10]?.v || "-", note: c[13]?.v || ""
                    };
                }).filter(e => e !== null);
                indicator.style.width = '100%';
                fastRender(); // ì¼ì • ë°ì´í„° ì™”ìœ¼ë‹ˆ ë‹¤ì‹œ ê·¸ë¦¼
                openDayInfo(todayObj.getFullYear(), todayObj.getMonth(), todayObj.getDate(), false);
                setTimeout(() => indicator.style.width = '0%', 400);
            } catch (e) { indicator.style.width = '0%'; }
        }

        function parseGoogleDate(v) {
            if (!v) return null;
            if (typeof v === 'string' && v.startsWith('Date')) {
                const m = v.match(/Date\((\d+),(\d+),(\d+)\)/);
                return m ? new Date(m[1], m[2], m[3]) : new Date(v);
            }
            return new Date(v);
        }

        function generateMonthHtml(date) {
            const y = date.getFullYear(), m = date.getMonth();
            const last = new Date(y, m+1, 0).getDate();
            const first = new Date(y, m, 1).getDay();
            let html = '';
            for(let i=0; i<first; i++) html += '<div></div>';
            for(let i=1; i<=last; i++) {
                const target = new Date(y, m, i);
                const hDate = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const holiday = holidays[hDate];
                const dayEvents = events.filter(e => {
                    if(!e.start) return false;
                    const s = new Date(e.start); s.setHours(0,0,0,0);
                    const end = e.end ? new Date(e.end) : new Date(e.start); end.setHours(23,59,59,999);
                    return target >= s && target <= end;
                });
                const isToday = (target.toDateString() === todayObj.toDateString());
                const color = (target.getDay() === 0 || holiday) ? 'text-red-500' : target.getDay() === 6 ? 'text-blue-500' : 'text-slate-800';
                const eventHtml = dayEvents.map(e => `<div class="event-bar border ${e.meetingType === 'ì£¼ì¼ì§‘íšŒ' ? 'bg-red-50 text-red-600 border-red-100' : e.meetingType === 'ì†Œê·¸ë£¹' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-green-50 text-green-600 border-green-100'}">${e.meetingType}</div>`).join('');
                
                html += `<div id="day-${y}-${m}-${i}" class="calendar-day" onclick="openDayInfo(${y}, ${m}, ${i}, false)"><div class="date-label ${isToday ? 'bg-orange-500 text-white rounded-full w-6 h-6 md:w-8 md:h-8 flex items-center justify-center shadow-md' : 'w-6 h-6 md:w-8 md:h-8 flex items-center justify-center ' + color}">${i}</div>${holiday ? `<div class="holiday-label">${holiday}</div>` : ''}<div class="event-container">${eventHtml}</div></div>`;
            }
            return html;
        }

        window.openDayInfo = (y, m, d, doScroll = true) => {
            document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected-day'));
            const selectedEl = document.getElementById(`day-${y}-${m}-${d}`);
            if(selectedEl) selectedEl.classList.add('selected-day');

            const target = new Date(y, m, d);
            const hDate = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const holiday = holidays[hDate];
            const dayEvents = events.filter(e => {
                const s = new Date(e.start); s.setHours(0,0,0,0);
                const end = e.end ? new Date(e.end) : new Date(e.start); end.setHours(23,59,59,999);
                return target >= s && target <= end;
            });

            let html = `<div class="flex items-center gap-3 mb-4 px-4 ribbon-enter"><span class="text-3xl font-black ${target.getDay() === 0 || holiday ? 'text-red-500' : 'text-slate-800'}">${d}</span><div class="text-sm font-bold text-slate-500"><div>${y}ë…„ ${m+1}ì›”</div><div>${WEEK_NAMES[target.getDay()]} ${holiday ? `<span class="text-red-400">| ${holiday}</span>` : ''}</div></div></div>`;

            if (dayEvents.length === 0) {
                html += `<div class="text-center py-10 bg-white rounded-3xl border border-slate-100 ribbon-enter"><p class="text-slate-300 font-bold">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
            } else {
                html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 ribbon-enter">`;
                dayEvents.forEach(e => {
                    const colorSet = e.meetingType === 'ì£¼ì¼ì§‘íšŒ' ? 'bg-red-50 text-red-600' : e.meetingType === 'ì†Œê·¸ë£¹' ? 'bg-blue-50 text-blue-600' : 'bg-green-50 text-green-600';
                    html += `<div class="bg-white p-5 rounded-3xl border border-slate-50 shadow-sm"><div class="flex justify-between items-start mb-2"><span class="px-2 py-0.5 ${colorSet} rounded-lg text-[9px] font-black">${e.meetingType}</span><span class="text-[10px] font-bold text-slate-400">${e.startTime || 'ì¢…ì¼'}</span></div><h3 class="text-base font-black text-slate-800 mb-1">${e.subject || e.meetingType}</h3><div class="text-[11px] text-slate-500 leading-relaxed">${e.note || ''}</div></div>`;
                });
                html += `</div>`;
            }
            document.getElementById('ribbonContent').innerHTML = html;
            if(doScroll) document.getElementById('detailRibbonSection').scrollIntoView({ behavior: 'smooth' });
        };

        function changeMonth(offset) {
            strip.classList.add('sliding-transition');
            strip.style.transform = `translateX(${offset > 0 ? -66.6666 : 0}%)`;
            setTimeout(() => {
                currentDate.setMonth(currentDate.getMonth() + offset);
                strip.classList.remove('sliding-transition');
                fastRender();
                strip.style.transform = `translateX(-33.3333%)`;
            }, 300);
        }

        window.handleSearch = () => {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            const res = events.filter(e => e.meetingType.includes(query) || e.subject.includes(query) || (e.note && e.note.includes(query)));
            let html = `<h2 class="text-lg font-black mb-4">'${query}' ê²€ìƒ‰ ê²°ê³¼</h2>`;
            if (res.length === 0) html += `<p class="py-6 text-slate-400 text-center text-sm">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            else res.forEach(e => {
                const d = new Date(e.start);
                html += `<div class="p-3 mb-2 bg-slate-50 rounded-xl cursor-pointer text-sm" onclick="closeModal(); setTimeout(()=> { currentDate = new Date(${d.getFullYear()}, ${d.getMonth()}, 1); fastRender(); openDayInfo(${d.getFullYear()}, ${d.getMonth()}, ${d.getDate()}, true); }, 100)"><div class="text-[9px] font-black text-orange-500">${d.getMonth()+1}ì›” ${d.getDate()}ì¼</div><div class="font-bold">${e.meetingType}: ${e.subject || ''}</div></div>`;
            });
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalOverlay').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('modalOverlay').classList.add('hidden');
        window.openInstallModal = () => {
            document.getElementById('modalContent').innerHTML = `<h3 class="text-lg font-black mb-4">í™ˆ í™”ë©´ ì¶”ê°€</h3><p class="text-sm text-slate-600 leading-relaxed"><b>iPhone:</b> ê³µìœ  ë²„íŠ¼ì„ ëˆ„ë¥´ê³  'í™ˆ í™”ë©´ì— ì¶”ê°€' ì„ íƒ<br><b>Android:</b> ì„¤ì •(ì 3ê°œ)ì„ ëˆ„ë¥´ê³  'í™ˆ í™”ë©´ì— ì¶”ê°€' ì„ íƒ</p>`;
            document.getElementById('modalOverlay').classList.remove('hidden');
        };

        // ì œìŠ¤ì²˜ ì§€ì›
        let startX_pos = 0;
        document.getElementById('calendarViewport').addEventListener('touchstart', e => { startX_pos = e.touches[0].clientX; strip.classList.remove('sliding-transition'); }, {passive: true});
        document.getElementById('calendarViewport').addEventListener('touchmove', e => {
            const dx = e.touches[0].clientX - startX_pos;
            strip.style.transform = `translateX(${-33.3333 + (dx / window.innerWidth) * 33.3333}%)`;
        }, {passive: true});
        document.getElementById('calendarViewport').addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - startX_pos;
            if (Math.abs(dx) > 50) changeMonth(dx > 0 ? -1 : 1);
            else { strip.classList.add('sliding-transition'); strip.style.transform = `translateX(-33.3333%)`; }
        }, {passive: true});

        document.getElementById('prevMonth').onclick = () => changeMonth(-1);
        document.getElementById('nextMonth').onclick = () => changeMonth(1);
        window.goToToday = () => { currentDate = new Date(todayObj.getFullYear(), todayObj.getMonth(), 1); fastRender(); openDayInfo(todayObj.getFullYear(), todayObj.getMonth(), todayObj.getDate(), true); };

        // ì‹¤í–‰
        fastRender();
        fetchEvents();
        // ê³µíœ´ì¼ ì‹¤ì‹œê°„ ë™ê¸°í™”ëŠ” ë‚˜ì¤‘ì— ì²œì²œíˆ
        setTimeout(async () => {
            try {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(HOLIDAY_ICS_URL)}&t=${Date.now()}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                const icsText = data.contents;
                const vevents = icsText.split('BEGIN:VEVENT');
                vevents.shift(); 
                vevents.forEach(vevent => {
                    const dMatch = vevent.match(/DTSTART(?:;VALUE=DATE)?:(\d{8})/);
                    const sMatch = vevent.match(/SUMMARY:(.*)/);
                    if (dMatch && sMatch) {
                        const ds = dMatch[1];
                        holidays[`${ds.substring(0, 4)}-${ds.substring(4, 6)}-${ds.substring(6, 8)}`] = sMatch[1].replace(/\r/g, '').replace(/\\,/g, ',').trim();
                    }
                });
                fastRender();
            } catch (e) {}
        }, 1000);
    </script>
</body>
</html>
