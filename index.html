<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì•ˆì–‘êµíšŒ ìœ ì´ˆë“±ë¶€ ì¼ì •</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #ffffff; 
            color: #222;
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden;
            margin: 0;
            line-height: 1.5;
        }
        #calendarViewport { position: relative; width: 100%; overflow: hidden; min-height: 400px; }
        #calendarStrip { display: flex; width: 300%; transform: translateX(-33.3333%); will-change: transform; }
        .month-view { width: 33.3333%; display: grid; grid-template-columns: repeat(7, 1fr); align-content: start; }
        .sliding-transition { transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        
        /* ë‚ ì§œ ì¹¸ ë””ìì¸ */
        .calendar-day { 
            height: 75px; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start; 
            padding-top: 8px;
            cursor: pointer; position: relative;
            border-bottom: 1px solid #f8fafc;
        }
        @media (min-width: 768px) { .calendar-day { height: 110px; } }

        /* ë‚ ì§œ ì›í˜• í‘œì‹œ */
        .day-circle {
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            font-weight: 700;
            font-size: 13px;
            z-index: 1;
            transition: background-color 0.2s;
            margin-bottom: 2px;
        }
        .today-circle { background-color: #000000 !important; color: #ffffff !important; }
        .selected-circle { background-color: #f1f5f9; color: #000000; }

        /* ì¼ì • ë°•ìŠ¤ í…ìŠ¤íŠ¸ í‘œì‹œ */
        .event-box-container { 
            width: 90%; 
            display: flex; flex-direction: column; gap: 2px; 
            margin-top: 2px; 
            overflow: hidden;
        }
        .mini-event-bar {
            font-size: 8px;
            padding: 1px 3px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: clip;
            font-weight: 800;
            text-align: center;
            border: 1px solid transparent;
            line-height: 1.2;
        }
        @media (min-width: 768px) { 
            .mini-event-bar { font-size: 10px; padding: 2px 4px; border-radius: 6px; } 
        }
        
        .bar-ì£¼ì¼ì§‘íšŒ { background-color: #fef2f2; color: #ef4444; border-color: #fee2e2; }
        .bar-ì†Œê·¸ë£¹ { background-color: #eff6ff; color: #3b82f6; border-color: #dbeafe; }
        .bar-ê¸°íƒ€ { background-color: #f0fdf4; color: #22c55e; border-color: #dcfce7; }

        .holiday-name { font-size: 8px; color: #ef4444; font-weight: 700; margin-top: -2px; width: 100%; text-align: center; white-space: nowrap; overflow: hidden; }
        
        /* ìƒì„¸ ë‚´ì—­ ì¹´ë“œ */
        .info-card { background: #fafafa; border-radius: 20px; padding: 20px; border-left: 5px solid #ddd; margin-bottom: 16px; }
        .border-ì£¼ì¼ì§‘íšŒ { border-left-color: #ef4444; }
        .border-ì†Œê·¸ë£¹ { border-left-color: #3b82f6; }
        .border-ê¸°íƒ€ { border-left-color: #22c55e; }

        .ribbon-enter { animation: ribbonIn 0.3s ease-out forwards; }
        @keyframes ribbonIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .search-box { background: #f1f5f9; border-radius: 12px; padding: 6px 12px; display: flex; align-items: center; width: 130px; }
        #statusIndicator { height: 2px; width: 0%; background: #fb923c; position: fixed; top: 0; left: 0; z-index: 100; transition: width 0.3s; }
    </style>
</head>
<body>

    <div id="statusIndicator"></div>

    <nav class="sticky top-0 z-40 bg-white/95 backdrop-blur-md border-b border-gray-100 h-16 flex items-center justify-between px-4">
        <div id="navTitle" class="text-xl md:text-3xl font-black tracking-tighter text-slate-800">2026. 2</div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ì¼ì • ê²€ìƒ‰" class="bg-transparent border-none outline-none text-xs font-bold w-full">
            <button id="searchBtn"><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
        </div>
    </nav>

    <div class="grid grid-cols-7 text-center pt-4 pb-2 text-[11px] font-bold text-gray-400 border-b border-gray-50 bg-white">
        <div class="text-red-500">ì£¼ì¼</div>
        <div>ì›”</div>
        <div>í™”</div>
        <div>ìˆ˜</div>
        <div>ëª©</div>
        <div>ê¸ˆ</div>
        <div class="text-blue-500">í† </div>
    </div>

    <main id="calendarViewport">
        <div id="calendarStrip">
            <div id="prevGrid" class="month-view"></div>
            <div id="currGrid" class="month-view"></div>
            <div id="nextGrid" class="month-view"></div>
        </div>
    </main>

    <section id="detailRibbonSection" class="px-6 py-8 border-t border-gray-100 min-h-[40vh] bg-white scroll-mt-20">
        <div class="w-10 h-1.5 bg-gray-100 rounded-full mx-auto mb-8"></div>
        <div id="ribbonContent" class="space-y-6"></div>
    </section>

    <!-- í•˜ë‹¨ ì˜¤ëŠ˜ ë²„íŠ¼ -->
    <div class="fixed bottom-8 left-0 right-0 flex justify-center pointer-events-none z-30">
        <button id="todayBtn" class="pointer-events-auto bg-white border border-gray-200 px-10 py-3.5 rounded-full text-sm font-black shadow-2xl active:scale-95 transition-all flex items-center gap-2">
            <span class="text-gray-300 font-normal">&lt;</span> ì˜¤ëŠ˜
        </button>
    </div>

    <!-- ì¢Œìš° ì´ë™ í™”ì‚´í‘œ -->
    <div class="absolute top-44 left-0 right-0 flex justify-between px-2 pointer-events-none z-10">
        <button id="prevMonth" class="p-2 text-slate-200 hover:text-orange-500 transition-colors pointer-events-auto">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path></svg>
        </button>
        <button id="nextMonth" class="p-2 text-slate-200 hover:text-orange-500 transition-colors pointer-events-auto">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
        </button>
    </div>

    <!-- ëª¨ë‹¬ -->
    <div id="modalOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-[32px] p-8 w-full max-w-sm relative shadow-2xl">
            <div id="modalContent" class="max-h-[60vh] overflow-y-auto no-scrollbar"></div>
            <button id="closeModalBtn" class="mt-8 w-full py-4 bg-gray-50 rounded-2xl font-bold text-gray-500 hover:bg-gray-100 transition-colors">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        const SHEET_ID = '18zGuXQQWPm_dM2W6xD2Ugysaiz-sukIFJByO_TZrFy0';
        const HOLIDAY_ICS_URL = 'https://calendar.google.com/calendar/ical/ko.south_korea%23holiday%40group.v.google.com/public/basic.ics';
        
        let events = [];
        let holidays = {
            "2025-01-28": "ì„¤ë‚ ", "2025-01-29": "ì„¤ë‚ ", "2025-01-30": "ì„¤ë‚ ", "2025-10-06": "ì¶”ì„",
            "2026-01-01": "ì‹ ì •", "2026-02-16": "ì„¤ë‚ ", "2026-02-17": "ì„¤ë‚ ", "2026-02-18": "ì„¤ë‚ ",
            "2026-03-01": "ì‚¼ì¼ì ˆ", "2026-03-02": "ëŒ€ì²´ê³µíœ´ì¼", "2026-05-05": "ì–´ë¦°ì´ë‚ ",
            "2026-05-24": "ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ", "2026-06-06": "í˜„ì¶©ì¼", "2026-08-15": "ê´‘ë³µì ˆ",
            "2026-10-03": "ê°œì²œì ˆ", "2026-10-09": "í•œê¸€ë‚ ", "2026-12-25": "ì„±íƒ„ì ˆ"
        };

        const todayObj = new Date();
        let currentDate = new Date(todayObj.getFullYear(), todayObj.getMonth(), 1);
        let selectedDate = new Date(todayObj.getFullYear(), todayObj.getMonth(), todayObj.getDate());
        const WEEK_NAMES = ['ì£¼ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];

        window.addEventListener('DOMContentLoaded', () => {
            initApp();
            bindEvents();
        });

        function bindEvents() {
            const getById = (id) => document.getElementById(id);
            if (getById('prevMonth')) getById('prevMonth').onclick = () => changeMonth(-1);
            if (getById('nextMonth')) getById('nextMonth').onclick = () => changeMonth(1);
            if (getById('todayBtn')) getById('todayBtn').onclick = goToToday;
            if (getById('searchBtn')) getById('searchBtn').onclick = handleSearch;
            if (getById('closeModalBtn')) getById('closeModalBtn').onclick = closeModal;
            
            const searchInput = getById('searchInput');
            if (searchInput) searchInput.onkeypress = (e) => { if (e.key === 'Enter') handleSearch(); };

            const viewport = getById('calendarViewport');
            const strip = getById('calendarStrip');
            let startX_pos = 0;
            if (viewport && strip) {
                viewport.addEventListener('touchstart', e => { startX_pos = e.touches[0].clientX; strip.classList.remove('sliding-transition'); }, {passive: true});
                viewport.addEventListener('touchmove', e => {
                    const dx = e.touches[0].clientX - startX_pos;
                    strip.style.transform = `translateX(${-33.3333 + (dx / window.innerWidth) * 33.3333}%)`;
                }, {passive: true});
                viewport.addEventListener('touchend', e => {
                    const dx = e.changedTouches[0].clientX - startX_pos;
                    if (Math.abs(dx) > 60) changeMonth(dx > 0 ? -1 : 1);
                    else { strip.classList.add('sliding-transition'); strip.style.transform = `translateX(-33.3333%)`; }
                }, {passive: true});
            }
        }

        function fastRender() {
            const navTitle = document.getElementById('navTitle');
            if (navTitle) navTitle.innerText = `${currentDate.getFullYear()}. ${currentDate.getMonth() + 1}`;
            document.getElementById('prevGrid').innerHTML = generateGrid(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            document.getElementById('currGrid').innerHTML = generateGrid(currentDate);
            document.getElementById('nextGrid').innerHTML = generateGrid(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
        }

        function generateGrid(baseDate) {
            const y = baseDate.getFullYear(), m = baseDate.getMonth();
            const last = new Date(y, m + 1, 0).getDate();
            const first = new Date(y, m, 1).getDay();
            let html = '';
            for(let i=0; i<first; i++) html += '<div></div>';
            for(let i=1; i<=last; i++) {
                const target = new Date(y, m, i);
                target.setHours(0,0,0,0);

                const dateKey = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const holiday = holidays[dateKey];
                const isToday = target.toDateString() === todayObj.toDateString();
                const isSelected = target.toDateString() === selectedDate.toDateString();
                
                const dayEvents = events.filter(e => {
                    if(!e.start) return false;
                    const s = new Date(e.start); s.setHours(0,0,0,0);
                    const end = e.end ? new Date(e.end) : new Date(e.start); 
                    end.setHours(23,59,59,999);
                    return target >= s && target <= end;
                });

                const isRed = target.getDay() === 0 || holiday;
                const colorClass = isRed ? 'text-red-500' : (target.getDay() === 6 ? 'text-blue-500' : 'text-gray-800');
                const circleClass = isToday ? 'today-circle' : (isSelected ? 'selected-circle' : '');
                
                let bars = '';
                if (dayEvents.length > 0) {
                    // ëª¨ì„ìœ í˜• ì¤‘ë³µ ì œê±° í›„ ìµœëŒ€ 2ê°œ í‘œì‹œ
                    const types = [...new Set(dayEvents.map(e => e.meetingType))];
                    bars = types.slice(0, 2).map(t => {
                        const typeClass = t === 'ì£¼ì¼ì§‘íšŒ' ? 'ì£¼ì¼ì§‘íšŒ' : (t === 'ì†Œê·¸ë£¹' ? 'ì†Œê·¸ë£¹' : 'ê¸°íƒ€');
                        return `<div class="mini-event-bar bar-${typeClass}">${t}</div>`;
                    }).join('');
                }

                html += `
                    <div class="calendar-day" onclick="onDayClick(${y}, ${m}, ${i})">
                        <div class="day-circle ${circleClass} ${colorClass}">${i}</div>
                        ${holiday ? `<div class="holiday-name">${holiday}</div>` : ''}
                        <div class="event-box-container">${bars}</div>
                    </div>`;
            }
            return html;
        }

        window.onDayClick = (y, m, d) => {
            selectedDate = new Date(y, m, d);
            fastRender();
            updateDetail(selectedDate);
        };

        function updateDetail(date) {
            const dateKey = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
            const holiday = holidays[dateKey];
            const dayEvents = events.filter(e => {
                if(!e.start) return false;
                const s = new Date(e.start); s.setHours(0,0,0,0);
                const end = e.end ? new Date(e.end) : new Date(e.start); 
                end.setHours(23,59,59,999);
                return date >= s && date <= end;
            });
            const contentEl = document.getElementById('ribbonContent');
            if (!contentEl) return;

            let html = `<div class="flex items-baseline gap-2 mb-6 ribbon-enter"><span class="text-3xl font-black ${date.getDay() === 0 || holiday ? 'text-red-500' : 'text-slate-800'}">${date.getDate()}. ${WEEK_NAMES[date.getDay()]}</span>${holiday ? `<span class="text-red-400 font-bold text-sm ml-1">${holiday}</span>` : ''}</div>`;
            if (dayEvents.length === 0) {
                html += `<div class="text-center py-10 ribbon-enter"><p class="text-gray-300 font-medium">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
            } else {
                dayEvents.forEach(e => {
                    const typeClass = e.meetingType === 'ì£¼ì¼ì§‘íšŒ' ? 'ì£¼ì¼ì§‘íšŒ' : (e.meetingType === 'ì†Œê·¸ë£¹' ? 'ì†Œê·¸ë£¹' : 'ê¸°íƒ€');
                    let subInfo = '';
                    if (e.meetingType === 'ì£¼ì¼ì§‘íšŒ') {
                        subInfo = `<div class="grid grid-cols-3 gap-2 mt-5 text-center"><div class="bg-white/60 p-2.5 rounded-xl border border-gray-100"><p class="text-[9px] text-gray-400 font-bold mb-1 uppercase">ì§„í–‰</p><p class="text-xs font-black text-slate-700">${e.leader}</p></div><div class="bg-white/60 p-2.5 rounded-xl border border-gray-100"><p class="text-[9px] text-gray-400 font-bold mb-1 uppercase">ë§ì”€</p><p class="text-xs font-black text-slate-700">${e.speaker}</p></div><div class="bg-red-50 p-2.5 rounded-xl border border-red-100"><p class="text-[9px] text-red-400 font-bold mb-1 uppercase">ë¶„ë°˜</p><p class="text-xs font-black text-red-600">${e.division}</p></div></div>`;
                    } else if (e.meetingType === 'ì†Œê·¸ë£¹') {
                        subInfo = `<div class="mt-5 space-y-4"><div class="flex justify-between text-[11px] font-bold px-1"><span>ì‹ì‚¬ì¤€ë¹„: <span class="text-blue-500">${e.mealPrep}</span></span><span>ì„¤ê±°ì§€: <span class="text-slate-400">${e.wash}</span></span></div><div class="bg-blue-50/50 border border-blue-100/50 p-4 rounded-2xl text-center"><p class="text-[10px] text-blue-400 font-black mb-1 uppercase tracking-widest">Menu</p><p class="text-base font-black text-slate-700">ğŸ½ï¸ ${e.menu}</p></div></div>`;
                    }
                    html += `<div class="info-card border-${typeClass} ribbon-enter"><div class="flex justify-between items-start mb-2"><span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">${e.meetingType}</span><span class="text-[11px] font-bold text-orange-500">${e.startTime} - ${e.endTime}</span></div><h3 class="text-lg font-black text-slate-800 leading-tight">${e.subject || e.meetingType}</h3>${subInfo}${e.note ? `<div class="mt-5 text-[11px] text-slate-500 leading-relaxed bg-white/50 p-3 rounded-xl border border-gray-100"><b>ë¹„ê³ :</b> ${e.note}</div>` : ''}</div>`;
                });
            }
            contentEl.innerHTML = html;
        }

        async function initApp() {
            fastRender();
            updateDetail(selectedDate);
            const indicator = document.getElementById('statusIndicator');
            if(indicator) indicator.style.width = '30%';
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&t=${Date.now()}`;
                const res = await fetch(url);
                const text = await res.text();
                const startIdx = text.indexOf('{');
                const endIdx = text.lastIndexOf('}');
                if (startIdx === -1) throw new Error("JSON Parsing Error");
                const json = JSON.parse(text.substring(startIdx, endIdx + 1));
                
                events = json.table.rows.map(r => {
                    const c = r.c;
                    if(!c || !c[0] || c[0].v === null) return null;
                    return {
                        start: parseGoogleDate(c[0]?.v), end: parseGoogleDate(c[1]?.v),
                        startTime: c[2]?.f || c[2]?.v || "", endTime: c[3]?.f || c[3]?.v || "",
                        meetingType: c[4]?.v || "ê¸°íƒ€",
                        leader: c[5]?.v || "-", speaker: c[6]?.v || "-", division: c[7]?.v || "-",
                        mealPrep: c[8]?.v || "-", menu: c[10]?.v || "-", wash: c[11]?.v || "-",
                        subject: c[12]?.v || "", note: c[13]?.v || ""
                    };
                }).filter(e => e !== null);

                if(indicator) indicator.style.width = '100%';
                fastRender();
                updateDetail(selectedDate);
                setTimeout(() => { if(indicator) indicator.style.width = '0%'; }, 500);
            } catch (e) { console.error('Data Load Error:', e); }

            // ê³µíœ´ì¼ ì—…ë°ì´íŠ¸
            setTimeout(async () => {
                try {
                    const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(HOLIDAY_ICS_URL)}`;
                    const r = await fetch(proxy);
                    const d = await r.json();
                    const vevents = d.contents.split('BEGIN:VEVENT');
                    vevents.shift();
                    vevents.forEach(v => {
                        const dMatch = v.match(/DTSTART(?:;VALUE=DATE)?:(\d{8})/);
                        const sMatch = v.match(/SUMMARY:(.*)/);
                        if(dMatch && sMatch) {
                            const ds = dMatch[1];
                            holidays[`${ds.substring(0,4)}-${ds.substring(4,6)}-${ds.substring(6,8)}`] = sMatch[1].replace(/\r/g,'').replace(/\\,/g,',').trim();
                        }
                    });
                    fastRender();
                } catch(e) {}
            }, 1000);
        }

        function parseGoogleDate(v) {
            if (!v) return null;
            if (typeof v === 'string' && v.startsWith('Date')) {
                const match = v.match(/Date\((\d+),(\d+),(\d+)\)/);
                if (match) return new Date(match[1], match[2], match[3]);
            }
            const d = new Date(v);
            return isNaN(d.getTime()) ? null : d;
        }

        function changeMonth(offset) {
            const strip = document.getElementById('calendarStrip');
            if (!strip) return;
            strip.classList.add('sliding-transition');
            strip.style.transform = `translateX(${offset > 0 ? -66.6666 : 0}%)`;
            setTimeout(() => {
                currentDate.setMonth(currentDate.getMonth() + offset);
                fastRender();
                strip.classList.remove('sliding-transition');
                strip.style.transform = `translateX(-33.3333%)`;
            }, 300);
        }

        function goToToday() {
            currentDate = new Date(todayObj.getFullYear(), todayObj.getMonth(), 1);
            selectedDate = new Date(todayObj.getFullYear(), todayObj.getMonth(), todayObj.getDate());
            fastRender();
            updateDetail(selectedDate);
            document.getElementById('detailRibbonSection')?.scrollIntoView({ behavior: 'smooth' });
        }

        function handleSearch() {
            const q = document.getElementById('searchInput')?.value.trim();
            if(!q) return;
            const res = events.filter(e => e.meetingType.includes(q) || e.subject.includes(q) || (e.note && e.note.includes(q)));
            let html = `<h2 class="text-xl font-black mb-6 text-slate-800">'${q}' ê²€ìƒ‰ ê²°ê³¼</h2>`;
            if(res.length === 0) html += `<p class="py-10 text-gray-400 text-center font-medium">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            else res.forEach(e => {
                const d = new Date(e.start);
                html += `<div class="p-4 mb-3 bg-gray-50 rounded-2xl cursor-pointer hover:bg-orange-50 transition-all" onclick="closeModal(); onDayClick(${d.getFullYear()},${d.getMonth()},${d.getDate()})"><div class="text-[10px] font-black text-blue-500 uppercase mb-1">${d.getMonth()+1}ì›” ${d.getDate()}ì¼</div><div class="font-bold text-slate-700">${e.meetingType}: ${e.subject || 'ìƒì„¸ ì¼ì •'}</div></div>`;
            });
            const modalContent = document.getElementById('modalContent');
            if (modalContent) { modalContent.innerHTML = html; document.getElementById('modalOverlay')?.classList.remove('hidden'); }
        }

        function closeModal() { document.getElementById('modalOverlay')?.classList.add('hidden'); }
    </script>
</body>
</html>
