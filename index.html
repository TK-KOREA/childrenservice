<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>안양교회 유초등부 일정</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #ffffff; 
            color: #222;
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden;
            margin: 0;
            line-height: 1.4;
        }

        /* 캘린더 슬라이더 레이아웃 */
        #calendarViewport { position: relative; width: 100%; overflow: hidden; min-height: 420px; touch-action: pan-y; }
        #calendarStrip { display: flex; width: 300%; transform: translateX(-33.3333%); will-change: transform; }
        .month-view { width: 33.3333%; display: grid; grid-template-columns: repeat(7, 1fr); align-content: start; }
        .sliding-transition { transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }

        /* 날짜 칸 스타일 (균등 크기 고정 및 테두리 표시) */
        .calendar-day { 
            height: 85px; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start; 
            padding: 4px;
            cursor: pointer; position: relative;
            border: 1px solid #f1f5f9;
            margin-right: -1px;
            margin-bottom: -1px;
            overflow: hidden;
        }
        @media (min-width: 768px) { .calendar-day { height: 120px; padding: 8px 6px; } }

        /* 날짜 헤더 */
        .day-header { 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: center; 
            margin-bottom: 4px; 
        }

        .day-circle {
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            font-weight: 700;
            font-size: 13px;
            z-index: 1;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .today-circle { background-color: #000000 !important; color: #ffffff !important; }
        .selected-circle { background-color: #f1f5f9; color: #000000; }
        .selected-day { border-color: #fb923c !important; z-index: 10; box-shadow: inset 0 0 0 1px #fb923c; }

        /* 일정 미니바 (가운데 정렬) */
        .event-box-container { 
            width: 100%; 
            display: flex; flex-direction: column; gap: 2px; 
            overflow: hidden;
        }
        .mini-event-bar {
            font-size: 8px;
            padding: 1.5px 4px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: clip;
            font-weight: 800;
            text-align: center;
            border: 1px solid transparent;
            line-height: 1.1;
            letter-spacing: -0.05em;
        }
        @media (min-width: 768px) { .mini-event-bar { font-size: 10px; padding: 2px 6px; border-radius: 4px; } }
        
        /* 모임유형별 색상 (소그룹: 파랑, 주일집회: 빨강, 기타: 보라) */
        .bar-주일집회 { background-color: #fef2f2; color: #ef4444; border-color: #fee2e2; }
        .bar-소그룹 { background-color: #eff6ff; color: #3b82f6; border-color: #dbeafe; }
        .bar-기타, .bar-HCD { background-color: #f5f3ff; color: #8b5cf6; border-color: #ede9fe; }

        .holiday-name { 
            font-size: 9px; color: #ef4444; font-weight: 700; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            width: 100%;
            text-align: center;
            margin-top: 1px;
        }
        
        /* 상세 정보 카드 */
        .info-card { background: #fafafa; border-radius: 24px; padding: 24px; border-left: 6px solid #ddd; margin-bottom: 20px; text-align: left; position: relative; }
        .border-주일집회 { border-left-color: #ef4444; }
        .border-소그룹 { border-left-color: #3b82f6; }
        .border-기타, .border-HCD { border-left-color: #8b5cf6; }

        /* 내용 박스 - 시트 서식 완벽 표현 */
        .content-box { 
            background: #ffffff; 
            border-radius: 12px; 
            padding: 18px; 
            border: 1px solid #eeeeee; 
            font-size: 14px; 
            color: #444; 
            line-height: 1.6; 
            word-break: break-word; 
            white-space: pre-wrap; 
            margin-top: 12px; 
            text-align: left; 
        }
        .content-box span { display: inline; line-height: inherit; }

        .ribbon-enter { animation: ribbonIn 0.3s ease-out forwards; }
        @keyframes ribbonIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .search-box { background: #f1f5f9; border-radius: 12px; padding: 6px 12px; display: flex; align-items: center; width: 110px; }
        #statusIndicator { height: 2px; width: 0%; background: #fb923c; position: fixed; top: 0; left: 0; z-index: 100; transition: width 0.3s; }
        
        .picker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .picker-btn { padding: 10px; border-radius: 12px; font-weight: 700; font-size: 13px; text-align: center; border: 1px solid #f1f5f9; transition: all 0.2s; }
        .picker-btn.active { background: #000; color: #fff; border-color: #000; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .error-container { padding: 24px; background: #fff1f2; border: 1px solid #fecaca; border-radius: 20px; margin: 20px; text-align: left; }
    </style>
</head>
<body>

    <div id="statusIndicator"></div>

    <nav class="sticky top-0 z-40 bg-white/95 backdrop-blur-md border-b border-gray-100 h-16 flex items-center justify-between px-4">
        <div class="flex items-center gap-1">
            <button id="prevMonth" class="p-2 text-slate-300 hover:text-orange-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div id="navTitle" class="text-xl md:text-2xl font-black tracking-tighter text-slate-800 cursor-pointer hover:text-orange-500 transition-colors flex items-center gap-1 text-center">
                데이터 로드 중... <svg class="w-4 h-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <button id="nextMonth" class="p-2 text-slate-300 hover:text-orange-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="검색" class="bg-transparent border-none outline-none text-xs font-bold w-full">
            <button id="searchBtn"><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
        </div>
    </nav>

    <div class="grid grid-cols-7 text-center pt-4 pb-2 text-[11px] font-bold text-gray-400 border-b border-gray-50 bg-white">
        <div class="text-red-500">주일</div>
        <div>월</div>
        <div>화</div>
        <div>수</div>
        <div>목</div>
        <div>금</div>
        <div class="text-blue-500">토</div>
    </div>

    <main id="calendarViewport">
        <div id="calendarStrip">
            <div id="prevGrid" class="month-view"></div>
            <div id="currGrid" class="month-view"></div>
            <div id="nextGrid" class="month-view"></div>
        </div>
    </main>

    <section id="detailRibbonSection" class="px-6 py-8 border-t border-gray-100 min-h-[40vh] bg-white scroll-mt-20">
        <div class="w-10 h-1.5 bg-gray-100 rounded-full mx-auto mb-10"></div>
        <div id="ribbonContent" class="space-y-8"></div>
    </section>

    <div class="fixed bottom-8 left-0 right-0 flex justify-center pointer-events-none z-30">
        <button id="todayBtn" class="pointer-events-auto bg-white border border-gray-200 px-10 py-3.5 rounded-full text-sm font-black shadow-2xl active:scale-95 transition-all flex items-center gap-2">
            <span class="text-gray-300 font-normal">&lt;</span> 오늘
        </button>
    </div>

    <div id="modalOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-[32px] p-8 w-full max-w-sm relative shadow-2xl">
            <div id="modalContent" class="max-h-[60vh] overflow-y-auto no-scrollbar"></div>
            <button id="closeModalBtn" class="mt-8 w-full py-4 bg-gray-50 rounded-2xl font-bold text-gray-500 hover:bg-gray-100 transition-colors text-sm">닫기</button>
        </div>
    </div>

    <script>
        // --- 구글 시트 REST API v4 설정 ---
        const SHEET_API_KEY = "AIzaSyBpK_l4T6TtI4T7xH0MnBSWCARszUxI9nA"; 
        const SHEET_ID = '18zGuXQQWPm_dM2W6xD2Ugysaiz-sukIFJByO_TZrFy0';
        const RANGE = "'시트1'!A2:P200"; 
        
        const HOLIDAY_ICS_URL = 'https://calendar.google.com/calendar/ical/ko.south_korea%23holiday%40group.v.google.com/public/basic.ics';
        
        let events = [];
        let holidays = {};

        const todayObj = new Date();
        todayObj.setHours(0,0,0,0);
        let currentDate = new Date(todayObj.getFullYear(), todayObj.getMonth(), 1);
        let selectedDate = new Date(todayObj);
        const WEEK_NAMES = ['주일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];

        /**
         * 구글 시트의 Rich Text와 기본 서식을 결합하여 HTML을 생성하는 고정밀 파서
         */
        function parseFullRichText(cell) {
            if (!cell || !cell.formattedValue) return "";
            
            const text = cell.formattedValue;
            const runs = cell.textFormatRuns;
            const baseFormat = cell.effectiveFormat?.textFormat || {};

            // 헬퍼: 서식 객체를 CSS 스타일 문자열로 변환
            const getStyle = (format) => {
                let s = "";
                if (format.bold) s += "font-weight: 800; color: #000; ";
                if (format.italic) s += "font-style: italic; ";
                if (format.underline) s += "text-decoration: underline; ";
                if (format.fontSize) s += `font-size: ${format.fontSize * 1.35}px; `;
                if (format.fontFamily) {
                    let ff = format.fontFamily;
                    if (ff.toLowerCase().includes("gungsuh")) ff = "'Gungsuh', '궁서', serif";
                    s += `font-family: ${ff}; `;
                }
                if (format.foregroundColor) {
                    const c = format.foregroundColor;
                    const r = Math.round((c.red || 0) * 255);
                    const g = Math.round((c.green || 0) * 255);
                    const b = Math.round((c.blue || 0) * 255);
                    s += `color: rgb(${r},${g},${b}); `;
                }
                return s;
            };

            // 서식 구간이 없으면 기본 서식만 적용하여 반환
            if (!runs || runs.length === 0) {
                return `<span style="${getStyle(baseFormat)}">${text}</span>`;
            }

            let html = "";
            for (let i = 0; i < runs.length; i++) {
                const start = runs[i].startIndex || 0;
                const end = (i + 1 < runs.length) ? runs[i+1].startIndex : text.length;
                const runFormat = runs[i].format || {};
                const mergedFormat = { ...baseFormat, ...runFormat };
                const segment = text.substring(start, end);
                html += `<span style="${getStyle(mergedFormat)}">${segment}</span>`;
            }
            return html;
        }

        async function fetchWithBackoff(url, retries = 5, delay = 1000) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error?.message || `HTTP ${response.status}`);
                }
                return response.json();
            } catch (error) {
                if (error.message.includes('not been used') || error.message.includes('disabled') || error.message.includes('Unable to parse range')) throw error;
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(url, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            initApp();
            bindEvents();
        });

        function bindEvents() {
            const getById = (id) => document.getElementById(id);
            if (getById('prevMonth')) getById('prevMonth').onclick = (e) => { e.stopPropagation(); changeMonth(-1); };
            if (getById('nextMonth')) getById('nextMonth').onclick = (e) => { e.stopPropagation(); changeMonth(1); };
            if (getById('navTitle')) getById('navTitle').onclick = openYearMonthPicker;
            if (getById('todayBtn')) getById('todayBtn').onclick = goToToday;
            if (getById('searchBtn')) getById('searchBtn').onclick = handleSearch;
            if (getById('closeModalBtn')) getById('closeModalBtn').onclick = closeModal;
            
            const viewport = getById('calendarViewport');
            const strip = getById('calendarStrip');
            let startX = 0, startY = 0, isHorizontalMove = false, isVerticalMove = false;

            if (viewport && strip) {
                viewport.addEventListener('touchstart', e => { 
                    startX = e.touches[0].clientX; startY = e.touches[0].clientY;
                    strip.classList.remove('sliding-transition'); 
                    isHorizontalMove = false; isVerticalMove = false;
                }, {passive: true});

                viewport.addEventListener('touchmove', e => {
                    const dx = e.touches[0].clientX - startX;
                    const dy = e.touches[0].clientY - startY;
                    if (!isHorizontalMove && !isVerticalMove) {
                        if (Math.abs(dx) > Math.abs(dy) + 15) isHorizontalMove = true;
                        else if (Math.abs(dy) > Math.abs(dx) + 5) isVerticalMove = true;
                    }
                    if (isHorizontalMove) {
                        strip.style.transform = `translateX(${-33.3333 + (dx / window.innerWidth) * 33.3333}%)`;
                        if (e.cancelable) e.preventDefault(); 
                    }
                }, {passive: false});

                viewport.addEventListener('touchend', e => {
                    if (isHorizontalMove) {
                        const dx = e.changedTouches[0].clientX - startX;
                        if (Math.abs(dx) > 60) changeMonth(dx > 0 ? -1 : 1);
                        else { strip.classList.add('sliding-transition'); strip.style.transform = `translateX(-33.3333%)`; }
                    }
                    isHorizontalMove = false;
                    isVerticalMove = false;
                }, {passive: true});
            }
        }

        function fastRender() {
            const navTitle = document.getElementById('navTitle');
            if (navTitle) navTitle.innerHTML = `${currentDate.getFullYear()}. ${currentDate.getMonth() + 1} <svg class="w-4 h-4 opacity-30 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>`;
            document.getElementById('prevGrid').innerHTML = generateGrid(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            document.getElementById('currGrid').innerHTML = generateGrid(currentDate);
            document.getElementById('nextGrid').innerHTML = generateGrid(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
        }

        function generateGrid(baseDate) {
            const y = baseDate.getFullYear(), m = baseDate.getMonth();
            const last = new Date(y, m + 1, 0).getDate();
            const first = new Date(y, m, 1).getDay();
            let html = '';
            for(let i=0; i<first; i++) html += '<div class="calendar-day opacity-0 pointer-events-none"></div>';
            for(let i=1; i<=last; i++) {
                const target = new Date(y, m, i);
                target.setHours(0,0,0,0);
                const dateKey = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const holiday = holidays[dateKey];
                const isToday = target.getTime() === todayObj.getTime();
                const isSelected = target.getTime() === selectedDate.getTime();
                
                const dayEvents = events.filter(e => {
                    if(!e || !e.start) return false;
                    const checkEnd = e.end || e.start;
                    return target >= e.start && target <= checkEnd;
                });

                const isRed = target.getDay() === 0 || holiday;
                const colorClass = isRed ? 'text-red-500' : (target.getDay() === 6 ? 'text-blue-500' : 'text-gray-800');
                const circleClass = isToday ? 'today-circle' : (isSelected ? 'selected-circle' : '');
                
                let bars = '';
                if (dayEvents.length > 0) {
                    const uniqueTypes = [...new Set(dayEvents.map(e => e.meetingType))];
                    bars = uniqueTypes.slice(0, 3).map(t => {
                        const tId = (t === '주일집회' || t === '소그룹') ? t : '기타';
                        return `<div class="mini-event-bar bar-${tId}">${t}</div>`;
                    }).join('');
                }

                html += `<div class="calendar-day ${isSelected ? 'selected-day' : ''}" onclick="onDayClick(${y}, ${m}, ${i})"><div class="day-header"><div class="day-circle ${circleClass} ${colorClass}">${i}</div>${holiday ? `<div class="holiday-name">${holiday}</div>` : ''}</div><div class="event-box-container">${bars}</div></div>`;
            }
            return html;
        }

        window.onDayClick = (y, m, d) => {
            selectedDate = new Date(y, m, d);
            selectedDate.setHours(0,0,0,0);
            fastRender();
            updateDetail(selectedDate);
        };

        function updateDetail(date) {
            const dayEvents = events.filter(e => {
                if(!e || !e.start) return false;
                const checkEnd = e.end || e.start;
                return date >= e.start && date <= checkEnd;
            });
            const contentEl = document.getElementById('ribbonContent');
            if (!contentEl) return;

            const dateKey = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
            const holiday = holidays[dateKey];

            let html = `<div class="flex items-baseline gap-2 mb-6 ribbon-enter"><span class="text-3xl font-black ${date.getDay() === 0 || holiday ? 'text-red-500' : 'text-slate-800'}">${date.getDate()}. ${WEEK_NAMES[date.getDay()]}</span></div>`;
            
            if (dayEvents.length === 0) {
                html += `<div class="text-center py-10 ribbon-enter"><p class="text-gray-300 font-medium">등록된 일정이 없습니다.</p></div>`;
            } else {
                dayEvents.forEach(e => {
                    // 데이터 안전 검사
                    if (!e || !e.start) return;

                    const tId = (e.meetingType === '주일집회' || e.meetingType === '소그룹') ? e.meetingType : '기타';
                    const isSameDay = e.start && e.end && e.start.getTime() === e.end.getTime();
                    let dateTimeStr = "";
                    
                    const startStr = `${e.start.getMonth() + 1}. ${e.start.getDate()}`;
                    dateTimeStr = (isSameDay || !e.end) ? startStr : `${startStr} - ${e.end.getMonth() + 1}. ${e.end.getDate()} `;
                    
                    if (e.startTime) dateTimeStr += ` (${e.startTime}${e.endTime ? ' - ' + e.endTime : ''})`;

                    html += `
                        <div class="info-card border-${tId} ribbon-enter">
                            <div class="flex justify-between items-center mb-4">
                                <div class="mini-event-bar bar-${tId} px-3 py-1 rounded text-[11px] font-black">${e.meetingType}</div>
                                <div class="text-[11px] font-bold text-orange-500 text-right">${dateTimeStr}</div>
                            </div>
                            <h3 class="text-xl font-black text-slate-800 leading-tight mb-2">${e.subject || e.meetingType}</h3>
                            ${e.contentHtml ? `<div class="content-box">${e.contentHtml}</div>` : ''}
                        </div>`;
                });
            }
            contentEl.innerHTML = html;
        }

        async function initApp() {
            fastRender();
            updateDetail(selectedDate);
            const indicator = document.getElementById('statusIndicator');
            if(indicator) indicator.style.width = '30%';
            
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?ranges=${encodeURIComponent(RANGE)}&includeGridData=true&key=${SHEET_API_KEY}`;
                const json = await fetchWithBackoff(url);
                
                if (json.sheets && json.sheets[0].data[0].rowData) {
                    const rows = json.sheets[0].data[0].rowData;
                    events = rows.map(row => {
                        if (!row.values || row.values.length < 1) return null;
                        const v = row.values;
                        const start = parseAnyDate(v[0]?.formattedValue);
                        const end = parseAnyDate(v[1]?.formattedValue);
                        if(!start) return null;
                        
                        return {
                            start: start,
                            end: end,
                            startTime: v[2]?.formattedValue || "",
                            endTime: v[3]?.formattedValue || "",
                            meetingType: v[4]?.formattedValue || "기타",
                            subject: v[5]?.formattedValue || "",
                            contentHtml: parseFullRichText(v[6]), 
                            note: v[15]?.formattedValue || ""
                        };
                    }).filter(e => e !== null && e.start !== null);
                }

                if(indicator) indicator.style.width = '100%';
                fastRender();
                updateDetail(selectedDate);
                setTimeout(() => { if(indicator) indicator.style.width = '0%'; }, 500);
            } catch (e) { 
                console.error('Data Load Error:', e);
                const contentEl = document.getElementById('ribbonContent');
                if (contentEl) contentEl.innerHTML = `<div class="error-container"><p class="text-red-400 font-medium">데이터 로드 오류: ${e.message}</p></div>`;
            }

            // 공휴일 로드
            setTimeout(async () => {
                try {
                    const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(HOLIDAY_ICS_URL)}`;
                    const r = await fetch(proxy);
                    const d = await r.json();
                    const vevents = d.contents.split('BEGIN:VEVENT');
                    vevents.shift();
                    vevents.forEach(v => {
                        const dMatch = v.match(/DTSTART(?:;VALUE=DATE)?:(\d{8})/);
                        const sMatch = v.match(/SUMMARY:(.*)/);
                        if(dMatch && sMatch) {
                            const ds = dMatch[1];
                            holidays[`${ds.substring(0,4)}-${ds.substring(4,6)}-${ds.substring(6,8)}`] = sMatch[1].replace(/\r/g,'').replace(/\\,/g,',').trim();
                        }
                    });
                    fastRender();
                } catch(e) {}
            }, 1000);
        }

        function parseAnyDate(v) {
            if (!v || String(v).trim() === "") return null;
            const parts = String(v).replace(/\s/g, '').split(/[\.\-\/]/).filter(p => p !== "");
            if (parts.length >= 3) {
                const year = parts[0].length === 4 ? parts[0] : parts[2];
                const month = parts[0].length === 4 ? parts[1] : parts[0];
                const day = parts[0].length === 4 ? parts[2] : parts[1];
                const d = new Date(parseInt(year), parseInt(month)-1, parseInt(day));
                if (isNaN(d.getTime())) return null;
                d.setHours(0,0,0,0);
                return d;
            }
            const d = new Date(v); 
            if(!isNaN(d.getTime())) { d.setHours(0,0,0,0); return d; }
            return null;
        }

        function changeMonth(offset) {
            const strip = document.getElementById('calendarStrip');
            if (!strip) return;
            strip.classList.add('sliding-transition');
            strip.style.transform = `translateX(${offset > 0 ? -66.6666 : 0}%)`;
            setTimeout(() => {
                currentDate.setMonth(currentDate.getMonth() + offset);
                fastRender();
                strip.classList.remove('sliding-transition');
                strip.style.transform = `translateX(-33.3333%)`;
            }, 300);
        }

        function goToToday() {
            currentDate = new Date(todayObj.getFullYear(), todayObj.getMonth(), 1);
            selectedDate = new Date(todayObj);
            fastRender();
            updateDetail(selectedDate);
            document.getElementById('detailRibbonSection')?.scrollIntoView({ behavior: 'smooth' });
        }

        function handleSearch() {
            const q = document.getElementById('searchInput')?.value.trim();
            if(!q) return;
            const res = events.filter(e => e.meetingType.includes(q) || (e.subject && e.subject.includes(q)));
            let html = `<h2 class="text-xl font-black mb-6 text-slate-800">'${q}' 검색 결과</h2>`;
            if(res.length === 0) html += `<p class="py-10 text-gray-400 text-center font-medium">결과가 없습니다.</p>`;
            else res.forEach(e => {
                const d = e.start;
                if(!d) return;
                html += `<div class="p-4 mb-3 bg-gray-50 rounded-2xl cursor-pointer hover:bg-orange-50 transition-all" onclick="closeModal(); onDayClick(${d.getFullYear()},${d.getMonth()},${d.getDate()})"><div class="text-[10px] font-black text-blue-500 uppercase mb-1">${d.getMonth()+1}월 ${d.getDate()}일</div><div class="font-bold text-slate-700">${e.meetingType}: ${e.subject || '상세 일정'}</div></div>`;
            });
            const modalContent = document.getElementById('modalContent');
            if (modalContent) { modalContent.innerHTML = html; document.getElementById('modalOverlay')?.classList.remove('hidden'); }
        }

        function closeModal() { document.getElementById('modalOverlay')?.classList.add('hidden'); }

        function openYearMonthPicker() {
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth();
            let html = `<h3 class="text-xl font-black mb-6 text-slate-800 text-center">이동할 날짜 선택</h3>`;
            html += `<p class="text-[10px] font-bold text-gray-400 uppercase mb-2 ml-1">Year</p><div class="picker-grid mb-6">`;
            for(let i = y - 2; i <= y + 2; i++) { html += `<button class="picker-btn ${i === y ? 'active' : ''}" onclick="selectPickerDate(${i}, null)">${i}</button>`; }
            html += `</div><p class="text-[10px] font-bold text-gray-400 uppercase mb-2 ml-1">Month</p><div class="picker-grid">`;
            for(let i = 0; i < 12; i++) { html += `<button class="picker-btn ${i === m ? 'active' : ''}" onclick="selectPickerDate(${y}, ${i})">${i + 1}월</button>`; }
            html += `</div>`;
            const modalContent = document.getElementById('modalContent');
            if (modalContent) { modalContent.innerHTML = html; document.getElementById('modalOverlay')?.classList.remove('hidden'); }
        }

        window.selectPickerDate = (y, m) => {
            if (m === null) { currentDate.setFullYear(y); openYearMonthPicker(); } 
            else { currentDate = new Date(y, m, 1); closeModal(); fastRender(); onDayClick(y, m, 1); }
        };
    </script>
</body>
</html>        }
        @media (min-width: 768px) { .calendar-day { height: 120px; padding: 8px 6px; } }

        /* 날짜 헤더 */
        .day-header { 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: center; 
            margin-bottom: 4px; 
        }

        .day-circle {
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            font-weight: 700;
            font-size: 13px;
            z-index: 1;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .today-circle { background-color: #000000 !important; color: #ffffff !important; }
        .selected-circle { background-color: #f1f5f9; color: #000000; }
        .selected-day { border-color: #fb923c !important; z-index: 10; box-shadow: inset 0 0 0 1px #fb923c; }

        /* 일정 미니바 */
        .event-box-container { 
            width: 100%; 
            display: flex; flex-direction: column; gap: 2px; 
            overflow: hidden;
        }
        .mini-event-bar {
            font-size: 8px;
            padding: 1.5px 4px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: clip;
            font-weight: 800;
            text-align: center;
            border: 1px solid transparent;
            line-height: 1.1;
            letter-spacing: -0.05em;
        }
        @media (min-width: 768px) { .mini-event-bar { font-size: 10px; padding: 2px 6px; border-radius: 4px; } }
        
        .bar-주일집회 { background-color: #fef2f2; color: #ef4444; border-color: #fee2e2; }
        .bar-소그룹 { background-color: #eff6ff; color: #3b82f6; border-color: #dbeafe; }
        .bar-기타, .bar-HCD { background-color: #f5f3ff; color: #8b5cf6; border-color: #ede9fe; }

        /* 공휴일 이름 스타일 */
        .holiday-name { 
            font-size: 9px; color: #ef4444; font-weight: 700; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            width: 100%;
            text-align: center;
            margin-top: 1px;
            min-height: 11px;
        }
        
        /* 상세 정보 카드 */
        .info-card { background: #fafafa; border-radius: 24px; padding: 24px; border-left: 6px solid #ddd; margin-bottom: 20px; text-align: left; position: relative; }
        .border-주일집회 { border-left-color: #ef4444; }
        .border-소그룹 { border-left-color: #3b82f6; }
        .border-기타, .border-HCD { border-left-color: #8b5cf6; }

        .content-box { 
            background: #ffffff; 
            border-radius: 12px; 
            padding: 18px; 
            border: 1px solid #eeeeee; 
            font-size: 14px; 
            color: #444; 
            line-height: 1.6; 
            word-break: break-word; 
            white-space: pre-wrap; 
            margin-top: 12px; 
            text-align: left; 
        }
        .content-box span { display: inline; line-height: 1.4; }

        .ribbon-enter { animation: ribbonIn 0.3s ease-out forwards; }
        @keyframes ribbonIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .search-box { background: #f1f5f9; border-radius: 12px; padding: 6px 12px; display: flex; align-items: center; width: 110px; }
        #statusIndicator { height: 2px; width: 0%; background: #fb923c; position: fixed; top: 0; left: 0; z-index: 100; transition: width 0.3s; }
        
        .picker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .picker-btn { padding: 10px; border-radius: 12px; font-weight: 700; font-size: 13px; text-align: center; border: 1px solid #f1f5f9; transition: all 0.2s; }
        .picker-btn.active { background: #000; color: #fff; border-color: #000; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .error-container { padding: 24px; background: #fff1f2; border: 1px solid #fecaca; border-radius: 20px; margin: 20px; text-align: left; }
    </style>
</head>
<body>

    <div id="statusIndicator"></div>

    <nav class="sticky top-0 z-40 bg-white/95 backdrop-blur-md border-b border-gray-100 h-16 flex items-center justify-between px-4">
        <div class="flex items-center gap-1">
            <button id="prevMonth" class="p-2 text-slate-300 hover:text-orange-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div id="navTitle" class="text-xl md:text-2xl font-black tracking-tighter text-slate-800 cursor-pointer hover:text-orange-500 transition-colors flex items-center gap-1 text-center">
                데이터 로드 중... <svg class="w-4 h-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <button id="nextMonth" class="p-2 text-slate-300 hover:text-orange-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="검색" class="bg-transparent border-none outline-none text-xs font-bold w-full">
            <button id="searchBtn"><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
        </div>
    </nav>

    <div class="grid grid-cols-7 text-center pt-4 pb-2 text-[11px] font-bold text-gray-400 border-b border-gray-50 bg-white">
        <div class="text-red-500">주일</div>
        <div>월</div>
        <div>화</div>
        <div>수</div>
        <div>목</div>
        <div>금</div>
        <div class="text-blue-500">토</div>
    </div>

    <main id="calendarViewport">
        <div id="calendarStrip">
            <div id="prevGrid" class="month-view"></div>
            <div id="currGrid" class="month-view"></div>
            <div id="nextGrid" class="month-view"></div>
        </div>
    </main>

    <section id="detailRibbonSection" class="px-6 py-8 border-t border-gray-100 min-h-[40vh] bg-white scroll-mt-20">
        <div class="w-10 h-1.5 bg-gray-100 rounded-full mx-auto mb-10"></div>
        <div id="ribbonContent" class="space-y-8"></div>
    </section>

    <div class="fixed bottom-8 left-0 right-0 flex justify-center pointer-events-none z-30">
        <button id="todayBtn" class="pointer-events-auto bg-white border border-gray-200 px-10 py-3.5 rounded-full text-sm font-black shadow-2xl active:scale-95 transition-all flex items-center gap-2">
            <span class="text-gray-300 font-normal">&lt;</span> 오늘
        </button>
    </div>

    <div id="modalOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-[32px] p-8 w-full max-w-sm relative shadow-2xl">
            <div id="modalContent" class="max-h-[60vh] overflow-y-auto no-scrollbar"></div>
            <button id="closeModalBtn" class="mt-8 w-full py-4 bg-gray-50 rounded-2xl font-bold text-gray-500 hover:bg-gray-100 transition-colors text-sm">닫기</button>
        </div>
    </div>

    <script>
        const SHEET_API_KEY = "AIzaSyBpK_l4T6TtI4T7xH0MnBSWCARszUxI9nA"; 
        const SHEET_ID = '18zGuXQQWPm_dM2W6xD2Ugysaiz-sukIFJByO_TZrFy0';
        const RANGE = "'시트1'!A2:P200"; 
        
        const HOLIDAY_ICS_URL = 'https://calendar.google.com/calendar/ical/ko.south_korea%23holiday%40group.v.google.com/public/basic.ics';
        
        let events = [];
        
        // 2025~2026 기본 공휴일 데이터 (ICS 로드 실패 시 백업 및 즉시 표시용)
        let holidays = {
            "2025-01-01": "신정", "2025-01-28": "설날", "2025-01-29": "설날", "2025-01-30": "설날",
            "2025-03-01": "삼일절", "2025-03-03": "대체공휴일", "2025-05-05": "어린이날/부처님오신날", 
            "2025-05-06": "대체공휴일", "2025-06-06": "현충일", "2025-08-15": "광복절",
            "2025-10-03": "개천절", "2025-10-06": "추석", "2025-10-07": "추석", "2025-10-08": "추석",
            "2025-10-09": "한글날", "2025-12-25": "성탄절",
            "2026-01-01": "신정", "2026-02-16": "설날", "2026-02-17": "설날", "2026-02-18": "설날",
            "2026-03-01": "삼일절", "2026-03-02": "대체공휴일", "2026-05-05": "어린이날",
            "2026-05-24": "부처님오신날", "2026-05-25": "대체공휴일", "2026-06-06": "현충일", 
            "2026-08-15": "광복절", "2026-08-17": "대체공휴일", "2026-09-24": "추석",
            "2026-09-25": "추석", "2026-09-26": "추석", "2026-10-03": "개천절", 
            "2026-10-05": "대체공휴일", "2026-10-09": "한글날", "2026-12-25": "성탄절"
        };

        const todayObj = new Date();
        todayObj.setHours(0,0,0,0);
        let currentDate = new Date(todayObj.getFullYear(), todayObj.getMonth(), 1);
        let selectedDate = new Date(todayObj);
        const WEEK_NAMES = ['주일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];

        function parseFullRichText(cell) {
            if (!cell || !cell.formattedValue) return "";
            const text = cell.formattedValue;
            const runs = cell.textFormatRuns;
            const baseFormat = cell.effectiveFormat?.textFormat || {};
            const getStyle = (f) => {
                let s = "";
                if (f.bold) s += "font-weight: 800; color: #000; ";
                if (f.italic) s += "font-style: italic; ";
                if (f.underline) s += "text-decoration: underline; ";
                if (f.fontSize) s += `font-size: ${f.fontSize * 1.35}px; `;
                if (f.fontFamily) {
                    let ff = f.fontFamily;
                    if (ff.toLowerCase().includes("gungsuh")) ff = "'Gungsuh', '궁서', serif";
                    s += `font-family: ${ff}; `;
                }
                if (f.foregroundColor) {
                    const c = f.foregroundColor;
                    const r = Math.round((c.red || 0) * 255);
                    const g = Math.round((c.green || 0) * 255);
                    const b = Math.round((c.blue || 0) * 255);
                    s += `color: rgb(${r},${g},${b}); `;
                }
                return s;
            };
            if (!runs || runs.length === 0) return `<span style="${getStyle(baseFormat)}">${text}</span>`;
            let html = "";
            for (let i = 0; i < runs.length; i++) {
                const start = runs[i].startIndex || 0;
                const end = (i + 1 < runs.length) ? runs[i+1].startIndex : text.length;
                const segment = text.substring(start, end);
                html += `<span style="${getStyle({ ...baseFormat, ...runs[i].format })}">${segment}</span>`;
            }
            return html;
        }

        async function fetchWithBackoff(url, retries = 5, delay = 1000) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error?.message || `HTTP ${response.status}`);
                }
                return response.json();
            } catch (error) {
                if (error.message.includes('not been used') || error.message.includes('disabled') || error.message.includes('Unable to parse range')) throw error;
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(url, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            initApp();
            bindEvents();
        });

        function bindEvents() {
            const getById = (id) => document.getElementById(id);
            if (getById('prevMonth')) getById('prevMonth').onclick = (e) => { e.stopPropagation(); changeMonth(-1); };
            if (getById('nextMonth')) getById('nextMonth').onclick = (e) => { e.stopPropagation(); changeMonth(1); };
            if (getById('navTitle')) getById('navTitle').onclick = openYearMonthPicker;
            if (getById('todayBtn')) getById('todayBtn').onclick = goToToday;
            if (getById('searchBtn')) getById('searchBtn').onclick = handleSearch;
            if (getById('closeModalBtn')) getById('closeModalBtn').onclick = closeModal;
            
            const viewport = getById('calendarViewport');
            const strip = getById('calendarStrip');
            let startX = 0, startY = 0, isHorizontalMove = false, isVerticalMove = false;

            if (viewport && strip) {
                viewport.addEventListener('touchstart', e => { 
                    startX = e.touches[0].clientX; startY = e.touches[0].clientY;
                    strip.classList.remove('sliding-transition'); 
                    isHorizontalMove = false; isVerticalMove = false;
                }, {passive: true});

                viewport.addEventListener('touchmove', e => {
                    const dx = e.touches[0].clientX - startX;
                    const dy = e.touches[0].clientY - startY;
                    if (!isHorizontalMove && !isVerticalMove) {
                        if (Math.abs(dx) > Math.abs(dy) + 15) isHorizontalMove = true;
                        else if (Math.abs(dy) > Math.abs(dx) + 5) isVerticalMove = true;
                    }
                    if (isHorizontalMove) {
                        strip.style.transform = `translateX(${-33.3333 + (dx / window.innerWidth) * 33.3333}%)`;
                        if (e.cancelable) e.preventDefault(); 
                    }
                }, {passive: false});

                viewport.addEventListener('touchend', e => {
                    if (isHorizontalMove) {
                        const dx = e.changedTouches[0].clientX - startX;
                        if (Math.abs(dx) > 60) changeMonth(dx > 0 ? -1 : 1);
                        else { strip.classList.add('sliding-transition'); strip.style.transform = `translateX(-33.3333%)`; }
                    }
                    isHorizontalMove = false;
                    isVerticalMove = false;
                }, {passive: true});
            }
        }

        function fastRender() {
            const navTitle = document.getElementById('navTitle');
            if (navTitle) navTitle.innerHTML = `${currentDate.getFullYear()}. ${currentDate.getMonth() + 1} <svg class="w-4 h-4 opacity-30 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>`;
            document.getElementById('prevGrid').innerHTML = generateGrid(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            document.getElementById('currGrid').innerHTML = generateGrid(currentDate);
            document.getElementById('nextGrid').innerHTML = generateGrid(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
        }

        function generateGrid(baseDate) {
            const y = baseDate.getFullYear(), m = baseDate.getMonth();
            const last = new Date(y, m + 1, 0).getDate();
            const first = new Date(y, m, 1).getDay();
            let html = '';
            for(let i=0; i<first; i++) html += '<div class="calendar-day opacity-0 pointer-events-none"></div>';
            for(let i=1; i<=last; i++) {
                const target = new Date(y, m, i);
                target.setHours(0,0,0,0);
                const dateKey = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const holidayName = holidays[dateKey];
                const isToday = target.getTime() === todayObj.getTime();
                const isSelected = target.getTime() === selectedDate.getTime();
                
                const dayEvents = events.filter(e => {
                    if(!e || !e.start) return false;
                    const checkEnd = e.end || e.start;
                    return target >= e.start && target <= checkEnd;
                });

                // 일요일(0) 또는 공휴일이면 빨간색
                const isRed = target.getDay() === 0 || holidayName;
                const colorClass = isRed ? 'text-red-500' : (target.getDay() === 6 ? 'text-blue-500' : 'text-gray-800');
                const circleClass = isToday ? 'today-circle' : (isSelected ? 'selected-circle' : '');
                
                let bars = '';
                if (dayEvents.length > 0) {
                    const uniqueTypes = [...new Set(dayEvents.map(e => e.meetingType))];
                    bars = uniqueTypes.slice(0, 3).map(t => {
                        const tId = (t === '주일집회' || t === '소그룹') ? t : '기타';
                        return `<div class="mini-event-bar bar-${tId}">${t}</div>`;
                    }).join('');
                }

                html += `
                    <div class="calendar-day ${isSelected ? 'selected-day' : ''}" onclick="onDayClick(${y}, ${m}, ${i})">
                        <div class="day-header">
                            <div class="day-circle ${circleClass} ${colorClass}">${i}</div>
                            <div class="holiday-name">${holidayName || ''}</div>
                        </div>
                        <div class="event-box-container">${bars}</div>
                    </div>`;
            }
            return html;
        }

        window.onDayClick = (y, m, d) => {
            selectedDate = new Date(y, m, d);
            selectedDate.setHours(0,0,0,0);
            fastRender();
            updateDetail(selectedDate);
        };

        function updateDetail(date) {
            const dayEvents = events.filter(e => {
                if(!e || !e.start) return false;
                const checkEnd = e.end || e.start;
                return date >= e.start && date <= checkEnd;
            });
            const contentEl = document.getElementById('ribbonContent');
            if (!contentEl) return;

            const dateKey = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
            const holidayName = holidays[dateKey];

            let html = `<div class="flex items-baseline gap-2 mb-6 ribbon-enter"><span class="text-3xl font-black ${date.getDay() === 0 || holidayName ? 'text-red-500' : 'text-slate-800'}">${date.getDate()}. ${WEEK_NAMES[date.getDay()]}</span>${holidayName ? `<span class="text-red-400 font-bold text-sm ml-1">${holidayName}</span>` : ''}</div>`;
            
            if (dayEvents.length === 0) {
                html += `<div class="text-center py-10 ribbon-enter"><p class="text-gray-300 font-medium">등록된 일정이 없습니다.</p></div>`;
            } else {
                dayEvents.forEach(e => {
                    if (!e || !e.start) return;
                    const tId = (e.meetingType === '주일집회' || e.meetingType === '소그룹') ? e.meetingType : '기타';
                    const isSameDay = e.start && e.end && e.start.getTime() === e.end.getTime();
                    let dateTimeStr = "";
                    const startStr = `${e.start.getMonth() + 1}. ${e.start.getDate()}`;
                    dateTimeStr = (isSameDay || !e.end) ? startStr : `${startStr} - ${e.end.getMonth() + 1}. ${e.end.getDate()} `;
                    if (e.startTime) dateTimeStr += ` (${e.startTime}${e.endTime ? ' - ' + e.endTime : ''})`;

                    html += `
                        <div class="info-card border-${tId} ribbon-enter">
                            <div class="flex justify-between items-center mb-4">
                                <div class="mini-event-bar bar-${tId} px-3 py-1 rounded text-[11px] font-black">${e.meetingType}</div>
                                <div class="text-[11px] font-bold text-orange-500 text-right">${dateTimeStr}</div>
                            </div>
                            <h3 class="text-xl font-black text-slate-800 leading-tight mb-2">${e.subject || e.meetingType}</h3>
                            ${e.contentHtml ? `<div class="content-box">${e.contentHtml}</div>` : ''}
                        </div>`;
                });
            }
            contentEl.innerHTML = html;
        }

        async function initApp() {
            fastRender();
            updateDetail(selectedDate);
            const indicator = document.getElementById('statusIndicator');
            if(indicator) indicator.style.width = '30%';
            
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?ranges=${encodeURIComponent(RANGE)}&includeGridData=true&key=${SHEET_API_KEY}`;
                const json = await fetchWithBackoff(url);
                
                if (json.sheets && json.sheets[0].data[0].rowData) {
                    const rows = json.sheets[0].data[0].rowData;
                    events = rows.map(row => {
                        if (!row.values || row.values.length < 1) return null;
                        const v = row.values;
                        const start = parseAnyDate(v[0]?.formattedValue);
                        const end = parseAnyDate(v[1]?.formattedValue);
                        if(!start) return null;
                        return {
                            start: start, end: end,
                            startTime: v[2]?.formattedValue || "", endTime: v[3]?.formattedValue || "",
                            meetingType: v[4]?.formattedValue || "기타",
                            subject: v[5]?.formattedValue || "",
                            contentHtml: parseFullRichText(v[6]), 
                            note: v[15]?.formattedValue || ""
                        };
                    }).filter(e => e !== null);
                }
            } catch (e) { console.error('Data Load Error:', e); }

            // 공휴일 로드 (ICS 비동기 로드 + 내장 데이터 병합)
            fetchHolidays();

            if(indicator) indicator.style.width = '100%';
            fastRender();
            updateDetail(selectedDate);
            setTimeout(() => { if(indicator) indicator.style.width = '0%'; }, 500);
        }

        async function fetchHolidays() {
            try {
                // allorigins 프록시 사용
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(HOLIDAY_ICS_URL)}&t=${Date.now()}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                const content = data.contents;
                
                const vevents = content.split('BEGIN:VEVENT');
                vevents.shift();
                vevents.forEach(v => {
                    const dMatch = v.match(/DTSTART(?:;VALUE=DATE)?:(\d{8})/);
                    const sMatch = v.match(/SUMMARY:(.*)/);
                    if(dMatch && sMatch) {
                        const ds = dMatch[1];
                        const dateKey = `${ds.substring(0,4)}-${ds.substring(4,6)}-${ds.substring(6,8)}`;
                        const summary = sMatch[1].replace(/\r/g,'').replace(/\\,/g,',').trim();
                        // 내장 데이터보다 ICS 실시간 데이터를 우선시하여 병합
                        holidays[dateKey] = summary;
                    }
                });
                // 로드 완료 후 리렌더링
                fastRender();
                updateDetail(selectedDate);
            } catch(e) { 
                console.warn("ICS Holiday fetch failed, using built-in data.", e); 
            }
        }

        function parseAnyDate(v) {
            if (!v || String(v).trim() === "") return null;
            const parts = String(v).replace(/\s/g, '').split(/[\.\-\/]/).filter(p => p !== "");
            if (parts.length >= 3) {
                const year = parts[0].length === 4 ? parts[0] : parts[2];
                const month = parts[0].length === 4 ? parts[1] : parts[0];
                const day = parts[0].length === 4 ? parts[2] : parts[1];
                const d = new Date(parseInt(year), parseInt(month)-1, parseInt(day));
                if (isNaN(d.getTime())) return null;
                d.setHours(0,0,0,0);
                return d;
            }
            const d = new Date(v); 
            if(!isNaN(d.getTime())) { d.setHours(0,0,0,0); return d; }
            return null;
        }

        function changeMonth(offset) {
            const strip = document.getElementById('calendarStrip');
            if (!strip) return;
            strip.classList.add('sliding-transition');
            strip.style.transform = `translateX(${offset > 0 ? -66.6666 : 0}%)`;
            setTimeout(() => {
                currentDate.setMonth(currentDate.getMonth() + offset);
                fastRender();
                strip.classList.remove('sliding-transition');
                strip.style.transform = `translateX(-33.3333%)`;
            }, 300);
        }

        function goToToday() {
            currentDate = new Date(todayObj.getFullYear(), todayObj.getMonth(), 1);
            selectedDate = new Date(todayObj);
            fastRender();
            updateDetail(selectedDate);
            document.getElementById('detailRibbonSection')?.scrollIntoView({ behavior: 'smooth' });
        }

        function handleSearch() {
            const q = document.getElementById('searchInput')?.value.trim();
            if(!q) return;
            const res = events.filter(e => e.meetingType.includes(q) || (e.subject && e.subject.includes(q)));
            let html = `<h2 class="text-xl font-black mb-6 text-slate-800">'${q}' 검색 결과</h2>`;
            if(res.length === 0) html += `<p class="py-10 text-gray-400 text-center font-medium">결과가 없습니다.</p>`;
            else res.forEach(e => {
                const d = e.start;
                if(!d) return;
                html += `<div class="p-4 mb-3 bg-gray-50 rounded-2xl cursor-pointer hover:bg-orange-50 transition-all" onclick="closeModal(); onDayClick(${d.getFullYear()},${d.getMonth()},${d.getDate()})"><div class="text-[10px] font-black text-blue-500 uppercase mb-1">${d.getMonth()+1}월 ${d.getDate()}일</div><div class="font-bold text-slate-700">${e.meetingType}: ${e.subject || '상세 일정'}</div></div>`;
            });
            const modalContent = document.getElementById('modalContent');
            if (modalContent) { modalContent.innerHTML = html; document.getElementById('modalOverlay')?.classList.remove('hidden'); }
        }

        function closeModal() { document.getElementById('modalOverlay')?.classList.add('hidden'); }

        function openYearMonthPicker() {
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth();
            let html = `<h3 class="text-xl font-black mb-6 text-slate-800 text-center">이동할 날짜 선택</h3>`;
            html += `<p class="text-[10px] font-bold text-gray-400 uppercase mb-2 ml-1">Year</p><div class="picker-grid mb-6">`;
            for(let i = y - 2; i <= y + 2; i++) { html += `<button class="picker-btn ${i === y ? 'active' : ''}" onclick="selectPickerDate(${i}, null)">${i}</button>`; }
            html += `</div><p class="text-[10px] font-bold text-gray-400 uppercase mb-2 ml-1">Month</p><div class="picker-grid">`;
            for(let i = 0; i < 12; i++) { html += `<button class="picker-btn ${i === m ? 'active' : ''}" onclick="selectPickerDate(${y}, ${i})">${i + 1}월</button>`; }
            html += `</div>`;
            const modalContent = document.getElementById('modalContent');
            if (modalContent) { modalContent.innerHTML = html; document.getElementById('modalOverlay')?.classList.remove('hidden'); }
        }

        window.selectPickerDate = (y, m) => {
            if (m === null) { currentDate.setFullYear(y); openYearMonthPicker(); } 
            else { currentDate = new Date(y, m, 1); closeModal(); fastRender(); onDayClick(y, m, 1); }
        };
    </script>
</body>
</html>

        }
        @media (min-width: 768px) { .calendar-day { height: 120px; padding: 8px 6px; } }

        /* 날짜 헤더 */
        .day-header { 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: center; 
            margin-bottom: 4px; 
        }

        .day-circle {
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            font-weight: 700;
            font-size: 13px;
            z-index: 1;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .today-circle { background-color: #000000 !important; color: #ffffff !important; }
        .selected-circle { background-color: #f1f5f9; color: #000000; }
        .selected-day { border-color: #fb923c !important; z-index: 10; box-shadow: inset 0 0 0 1px #fb923c; }

        /* 일정 미니바 (가운데 정렬) */
        .event-box-container { 
            width: 100%; 
            display: flex; flex-direction: column; gap: 2px; 
            overflow: hidden;
        }
        .mini-event-bar {
            font-size: 8px;
            padding: 1.5px 4px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: clip;
            font-weight: 800;
            text-align: center;
            border: 1px solid transparent;
            line-height: 1.1;
            letter-spacing: -0.05em;
        }
        @media (min-width: 768px) { .mini-event-bar { font-size: 10px; padding: 2px 6px; border-radius: 4px; } }
        
        /* 모임유형별 색상 (소그룹: 파랑, 주일집회: 빨강, 기타: 보라) */
        .bar-주일집회 { background-color: #fef2f2; color: #ef4444; border-color: #fee2e2; }
        .bar-소그룹 { background-color: #eff6ff; color: #3b82f6; border-color: #dbeafe; }
        .bar-기타, .bar-HCD { background-color: #f5f3ff; color: #8b5cf6; border-color: #ede9fe; }

        .holiday-name { 
            font-size: 9px; color: #ef4444; font-weight: 700; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            width: 100%;
            text-align: center;
            margin-top: 1px;
        }
        
        /* 상세 정보 카드 */
        .info-card { background: #fafafa; border-radius: 24px; padding: 24px; border-left: 6px solid #ddd; margin-bottom: 20px; text-align: left; position: relative; }
        .border-주일집회 { border-left-color: #ef4444; }
        .border-소그룹 { border-left-color: #3b82f6; }
        .border-기타, .border-HCD { border-left-color: #8b5cf6; }

        /* 내용 박스 - 시트 서식 완벽 표현 */
        .content-box { 
            background: #ffffff; 
            border-radius: 12px; 
            padding: 18px; 
            border: 1px solid #eeeeee; 
            font-size: 14px; 
            color: #444; 
            line-height: 1.6; 
            word-break: break-word; 
            white-space: pre-wrap; 
            margin-top: 12px; 
            text-align: left; 
        }
        .content-box span { display: inline; line-height: inherit; }

        .ribbon-enter { animation: ribbonIn 0.3s ease-out forwards; }
        @keyframes ribbonIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .search-box { background: #f1f5f9; border-radius: 12px; padding: 6px 12px; display: flex; align-items: center; width: 110px; }
        #statusIndicator { height: 2px; width: 0%; background: #fb923c; position: fixed; top: 0; left: 0; z-index: 100; transition: width 0.3s; }
        
        .picker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .picker-btn { padding: 10px; border-radius: 12px; font-weight: 700; font-size: 13px; text-align: center; border: 1px solid #f1f5f9; transition: all 0.2s; }
        .picker-btn.active { background: #000; color: #fff; border-color: #000; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .error-container { padding: 24px; background: #fff1f2; border: 1px solid #fecaca; border-radius: 20px; margin: 20px; text-align: left; }
    </style>
</head>
<body>

    <div id="statusIndicator"></div>

    <nav class="sticky top-0 z-40 bg-white/95 backdrop-blur-md border-b border-gray-100 h-16 flex items-center justify-between px-4">
        <div class="flex items-center gap-1">
            <button id="prevMonth" class="p-2 text-slate-300 hover:text-orange-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div id="navTitle" class="text-xl md:text-2xl font-black tracking-tighter text-slate-800 cursor-pointer hover:text-orange-500 transition-colors flex items-center gap-1 text-center">
                데이터 로드 중... <svg class="w-4 h-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <button id="nextMonth" class="p-2 text-slate-300 hover:text-orange-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="검색" class="bg-transparent border-none outline-none text-xs font-bold w-full">
            <button id="searchBtn"><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
        </div>
    </nav>

    <div class="grid grid-cols-7 text-center pt-4 pb-2 text-[11px] font-bold text-gray-400 border-b border-gray-50 bg-white">
        <div class="text-red-500">주일</div>
        <div>월</div>
        <div>화</div>
        <div>수</div>
        <div>목</div>
        <div>금</div>
        <div class="text-blue-500">토</div>
    </div>

    <main id="calendarViewport">
        <div id="calendarStrip">
            <div id="prevGrid" class="month-view"></div>
            <div id="currGrid" class="month-view"></div>
            <div id="nextGrid" class="month-view"></div>
        </div>
    </main>

    <section id="detailRibbonSection" class="px-6 py-8 border-t border-gray-100 min-h-[40vh] bg-white scroll-mt-20">
        <div class="w-10 h-1.5 bg-gray-100 rounded-full mx-auto mb-10"></div>
        <div id="ribbonContent" class="space-y-8"></div>
    </section>

    <div class="fixed bottom-8 left-0 right-0 flex justify-center pointer-events-none z-30">
        <button id="todayBtn" class="pointer-events-auto bg-white border border-gray-200 px-10 py-3.5 rounded-full text-sm font-black shadow-2xl active:scale-95 transition-all flex items-center gap-2">
            <span class="text-gray-300 font-normal">&lt;</span> 오늘
        </button>
    </div>

    <div id="modalOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-[32px] p-8 w-full max-w-sm relative shadow-2xl">
            <div id="modalContent" class="max-h-[60vh] overflow-y-auto no-scrollbar"></div>
            <button id="closeModalBtn" class="mt-8 w-full py-4 bg-gray-50 rounded-2xl font-bold text-gray-500 hover:bg-gray-100 transition-colors text-sm">닫기</button>
        </div>
    </div>

    <script>
        // --- 구글 시트 REST API v4 설정 ---
        const SHEET_API_KEY = "AIzaSyBpK_l4T6TtI4T7xH0MnBSWCARszUxI9nA"; 
        const SHEET_ID = '18zGuXQQWPm_dM2W6xD2Ugysaiz-sukIFJByO_TZrFy0';
        const RANGE = "'시트1'!A2:P200"; 
        
        const HOLIDAY_ICS_URL = 'https://calendar.google.com/calendar/ical/ko.south_korea%23holiday%40group.v.google.com/public/basic.ics';
        
        let events = [];
        let holidays = {};

        const todayObj = new Date();
        todayObj.setHours(0,0,0,0);
        let currentDate = new Date(todayObj.getFullYear(), todayObj.getMonth(), 1);
        let selectedDate = new Date(todayObj);
        const WEEK_NAMES = ['주일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];

        /**
         * 구글 시트의 Rich Text와 기본 서식을 결합하여 HTML을 생성하는 고정밀 파서
         */
        function parseFullRichText(cell) {
            if (!cell || !cell.formattedValue) return "";
            
            const text = cell.formattedValue;
            const runs = cell.textFormatRuns;
            const baseFormat = cell.effectiveFormat?.textFormat || {};

            // 헬퍼: 서식 객체를 CSS 스타일 문자열로 변환
            const getStyle = (format) => {
                let s = "";
                if (format.bold) s += "font-weight: 800; color: #000; ";
                if (format.italic) s += "font-style: italic; ";
                if (format.underline) s += "text-decoration: underline; ";
                if (format.fontSize) s += `font-size: ${format.fontSize * 1.35}px; `;
                if (format.fontFamily) {
                    let ff = format.fontFamily;
                    if (ff.toLowerCase().includes("gungsuh")) ff = "'Gungsuh', '궁서', serif";
                    s += `font-family: ${ff}; `;
                }
                if (format.foregroundColor) {
                    const c = format.foregroundColor;
                    const r = Math.round((c.red || 0) * 255);
                    const g = Math.round((c.green || 0) * 255);
                    const b = Math.round((c.blue || 0) * 255);
                    s += `color: rgb(${r},${g},${b}); `;
                }
                return s;
            };

            // 서식 구간이 없으면 기본 서식만 적용하여 반환
            if (!runs || runs.length === 0) {
                return `<span style="${getStyle(baseFormat)}">${text}</span>`;
            }

            let html = "";
            for (let i = 0; i < runs.length; i++) {
                const start = runs[i].startIndex || 0;
                const end = (i + 1 < runs.length) ? runs[i+1].startIndex : text.length;
                const runFormat = runs[i].format || {};
                const mergedFormat = { ...baseFormat, ...runFormat };
                const segment = text.substring(start, end);
                html += `<span style="${getStyle(mergedFormat)}">${segment}</span>`;
            }
            return html;
        }

        async function fetchWithBackoff(url, retries = 5, delay = 1000) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error?.message || `HTTP ${response.status}`);
                }
                return response.json();
            } catch (error) {
                if (error.message.includes('not been used') || error.message.includes('disabled') || error.message.includes('Unable to parse range')) throw error;
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(url, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            initApp();
            bindEvents();
        });

        function bindEvents() {
            const getById = (id) => document.getElementById(id);
            if (getById('prevMonth')) getById('prevMonth').onclick = (e) => { e.stopPropagation(); changeMonth(-1); };
            if (getById('nextMonth')) getById('nextMonth').onclick = (e) => { e.stopPropagation(); changeMonth(1); };
            if (getById('navTitle')) getById('navTitle').onclick = openYearMonthPicker;
            if (getById('todayBtn')) getById('todayBtn').onclick = goToToday;
            if (getById('searchBtn')) getById('searchBtn').onclick = handleSearch;
            if (getById('closeModalBtn')) getById('closeModalBtn').onclick = closeModal;
            
            const viewport = getById('calendarViewport');
            const strip = getById('calendarStrip');
            let startX = 0, startY = 0, isHorizontalMove = false, isVerticalMove = false;

            if (viewport && strip) {
                viewport.addEventListener('touchstart', e => { 
                    startX = e.touches[0].clientX; startY = e.touches[0].clientY;
                    strip.classList.remove('sliding-transition'); 
                    isHorizontalMove = false; isVerticalMove = false;
                }, {passive: true});

                viewport.addEventListener('touchmove', e => {
                    const dx = e.touches[0].clientX - startX;
                    const dy = e.touches[0].clientY - startY;
                    if (!isHorizontalMove && !isVerticalMove) {
                        if (Math.abs(dx) > Math.abs(dy) + 15) isHorizontalMove = true;
                        else if (Math.abs(dy) > Math.abs(dx) + 5) isVerticalMove = true;
                    }
                    if (isHorizontalMove) {
                        strip.style.transform = `translateX(${-33.3333 + (dx / window.innerWidth) * 33.3333}%)`;
                        if (e.cancelable) e.preventDefault(); 
                    }
                }, {passive: false});

                viewport.addEventListener('touchend', e => {
                    if (isHorizontalMove) {
                        const dx = e.changedTouches[0].clientX - startX;
                        if (Math.abs(dx) > 60) changeMonth(dx > 0 ? -1 : 1);
                        else { strip.classList.add('sliding-transition'); strip.style.transform = `translateX(-33.3333%)`; }
                    }
                    isHorizontalMove = false;
                    isVerticalMove = false;
                }, {passive: true});
            }
        }

        function fastRender() {
            const navTitle = document.getElementById('navTitle');
            if (navTitle) navTitle.innerHTML = `${currentDate.getFullYear()}. ${currentDate.getMonth() + 1} <svg class="w-4 h-4 opacity-30 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>`;
            document.getElementById('prevGrid').innerHTML = generateGrid(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            document.getElementById('currGrid').innerHTML = generateGrid(currentDate);
            document.getElementById('nextGrid').innerHTML = generateGrid(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
        }

        function generateGrid(baseDate) {
            const y = baseDate.getFullYear(), m = baseDate.getMonth();
            const last = new Date(y, m + 1, 0).getDate();
            const first = new Date(y, m, 1).getDay();
            let html = '';
            for(let i=0; i<first; i++) html += '<div class="calendar-day opacity-0 pointer-events-none"></div>';
            for(let i=1; i<=last; i++) {
                const target = new Date(y, m, i);
                target.setHours(0,0,0,0);
                const dateKey = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const holiday = holidays[dateKey];
                const isToday = target.getTime() === todayObj.getTime();
                const isSelected = target.getTime() === selectedDate.getTime();
                
                const dayEvents = events.filter(e => {
                    if(!e || !e.start) return false;
                    const checkEnd = e.end || e.start;
                    return target >= e.start && target <= checkEnd;
                });

                const isRed = target.getDay() === 0 || holiday;
                const colorClass = isRed ? 'text-red-500' : (target.getDay() === 6 ? 'text-blue-500' : 'text-gray-800');
                const circleClass = isToday ? 'today-circle' : (isSelected ? 'selected-circle' : '');
                
                let bars = '';
                if (dayEvents.length > 0) {
                    const uniqueTypes = [...new Set(dayEvents.map(e => e.meetingType))];
                    bars = uniqueTypes.slice(0, 3).map(t => {
                        const tId = (t === '주일집회' || t === '소그룹') ? t : '기타';
                        return `<div class="mini-event-bar bar-${tId}">${t}</div>`;
                    }).join('');
                }

                html += `<div class="calendar-day ${isSelected ? 'selected-day' : ''}" onclick="onDayClick(${y}, ${m}, ${i})"><div class="day-header"><div class="day-circle ${circleClass} ${colorClass}">${i}</div>${holiday ? `<div class="holiday-name">${holiday}</div>` : ''}</div><div class="event-box-container">${bars}</div></div>`;
            }
            return html;
        }

        window.onDayClick = (y, m, d) => {
            selectedDate = new Date(y, m, d);
            selectedDate.setHours(0,0,0,0);
            fastRender();
            updateDetail(selectedDate);
        };

        function updateDetail(date) {
            const dayEvents = events.filter(e => {
                if(!e || !e.start) return false;
                const checkEnd = e.end || e.start;
                return date >= e.start && date <= checkEnd;
            });
            const contentEl = document.getElementById('ribbonContent');
            if (!contentEl) return;

            const dateKey = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
            const holiday = holidays[dateKey];

            let html = `<div class="flex items-baseline gap-2 mb-6 ribbon-enter"><span class="text-3xl font-black ${date.getDay() === 0 || holiday ? 'text-red-500' : 'text-slate-800'}">${date.getDate()}. ${WEEK_NAMES[date.getDay()]}</span></div>`;
            
            if (dayEvents.length === 0) {
                html += `<div class="text-center py-10 ribbon-enter"><p class="text-gray-300 font-medium">등록된 일정이 없습니다.</p></div>`;
            } else {
                dayEvents.forEach(e => {
                    // 데이터 안전 검사
                    if (!e || !e.start) return;

                    const tId = (e.meetingType === '주일집회' || e.meetingType === '소그룹') ? e.meetingType : '기타';
                    const isSameDay = e.start && e.end && e.start.getTime() === e.end.getTime();
                    let dateTimeStr = "";
                    
                    const startStr = `${e.start.getMonth() + 1}. ${e.start.getDate()}`;
                    dateTimeStr = (isSameDay || !e.end) ? startStr : `${startStr} - ${e.end.getMonth() + 1}. ${e.end.getDate()} `;
                    
                    if (e.startTime) dateTimeStr += ` (${e.startTime}${e.endTime ? ' - ' + e.endTime : ''})`;

                    html += `
                        <div class="info-card border-${tId} ribbon-enter">
                            <div class="flex justify-between items-center mb-4">
                                <div class="mini-event-bar bar-${tId} px-3 py-1 rounded text-[11px] font-black">${e.meetingType}</div>
                                <div class="text-[11px] font-bold text-orange-500 text-right">${dateTimeStr}</div>
                            </div>
                            <h3 class="text-xl font-black text-slate-800 leading-tight mb-2">${e.subject || e.meetingType}</h3>
                            ${e.contentHtml ? `<div class="content-box">${e.contentHtml}</div>` : ''}
                        </div>`;
                });
            }
            contentEl.innerHTML = html;
        }

        async function initApp() {
            fastRender();
            updateDetail(selectedDate);
            const indicator = document.getElementById('statusIndicator');
            if(indicator) indicator.style.width = '30%';
            
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?ranges=${encodeURIComponent(RANGE)}&includeGridData=true&key=${SHEET_API_KEY}`;
                const json = await fetchWithBackoff(url);
                
                if (json.sheets && json.sheets[0].data[0].rowData) {
                    const rows = json.sheets[0].data[0].rowData;
                    events = rows.map(row => {
                        if (!row.values || row.values.length < 1) return null;
                        const v = row.values;
                        const start = parseAnyDate(v[0]?.formattedValue);
                        const end = parseAnyDate(v[1]?.formattedValue);
                        if(!start) return null;
                        
                        return {
                            start: start,
                            end: end,
                            startTime: v[2]?.formattedValue || "",
                            endTime: v[3]?.formattedValue || "",
                            meetingType: v[4]?.formattedValue || "기타",
                            subject: v[5]?.formattedValue || "",
                            contentHtml: parseFullRichText(v[6]), 
                            note: v[15]?.formattedValue || ""
                        };
                    }).filter(e => e !== null && e.start !== null);
                }

                if(indicator) indicator.style.width = '100%';
                fastRender();
                updateDetail(selectedDate);
                setTimeout(() => { if(indicator) indicator.style.width = '0%'; }, 500);
            } catch (e) { 
                console.error('Data Load Error:', e);
                const contentEl = document.getElementById('ribbonContent');
                if (contentEl) contentEl.innerHTML = `<div class="error-container"><p class="text-red-400 font-medium">데이터 로드 오류: ${e.message}</p></div>`;
            }

            // 공휴일 로드
            setTimeout(async () => {
                try {
                    const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(HOLIDAY_ICS_URL)}`;
                    const r = await fetch(proxy);
                    const d = await r.json();
                    const vevents = d.contents.split('BEGIN:VEVENT');
                    vevents.shift();
                    vevents.forEach(v => {
                        const dMatch = v.match(/DTSTART(?:;VALUE=DATE)?:(\d{8})/);
                        const sMatch = v.match(/SUMMARY:(.*)/);
                        if(dMatch && sMatch) {
                            const ds = dMatch[1];
                            holidays[`${ds.substring(0,4)}-${ds.substring(4,6)}-${ds.substring(6,8)}`] = sMatch[1].replace(/\r/g,'').replace(/\\,/g,',').trim();
                        }
                    });
                    fastRender();
                } catch(e) {}
            }, 1000);
        }

        function parseAnyDate(v) {
            if (!v || String(v).trim() === "") return null;
            const parts = String(v).replace(/\s/g, '').split(/[\.\-\/]/).filter(p => p !== "");
            if (parts.length >= 3) {
                const year = parts[0].length === 4 ? parts[0] : parts[2];
                const month = parts[0].length === 4 ? parts[1] : parts[0];
                const day = parts[0].length === 4 ? parts[2] : parts[1];
                const d = new Date(parseInt(year), parseInt(month)-1, parseInt(day));
                if (isNaN(d.getTime())) return null;
                d.setHours(0,0,0,0);
                return d;
            }
            const d = new Date(v); 
            if(!isNaN(d.getTime())) { d.setHours(0,0,0,0); return d; }
            return null;
        }

        function changeMonth(offset) {
            const strip = document.getElementById('calendarStrip');
            if (!strip) return;
            strip.classList.add('sliding-transition');
            strip.style.transform = `translateX(${offset > 0 ? -66.6666 : 0}%)`;
            setTimeout(() => {
                currentDate.setMonth(currentDate.getMonth() + offset);
                fastRender();
                strip.classList.remove('sliding-transition');
                strip.style.transform = `translateX(-33.3333%)`;
            }, 300);
        }

        function goToToday() {
            currentDate = new Date(todayObj.getFullYear(), todayObj.getMonth(), 1);
            selectedDate = new Date(todayObj);
            fastRender();
            updateDetail(selectedDate);
            document.getElementById('detailRibbonSection')?.scrollIntoView({ behavior: 'smooth' });
        }

        function handleSearch() {
            const q = document.getElementById('searchInput')?.value.trim();
            if(!q) return;
            const res = events.filter(e => e.meetingType.includes(q) || (e.subject && e.subject.includes(q)));
            let html = `<h2 class="text-xl font-black mb-6 text-slate-800">'${q}' 검색 결과</h2>`;
            if(res.length === 0) html += `<p class="py-10 text-gray-400 text-center font-medium">결과가 없습니다.</p>`;
            else res.forEach(e => {
                const d = e.start;
                if(!d) return;
                html += `<div class="p-4 mb-3 bg-gray-50 rounded-2xl cursor-pointer hover:bg-orange-50 transition-all" onclick="closeModal(); onDayClick(${d.getFullYear()},${d.getMonth()},${d.getDate()})"><div class="text-[10px] font-black text-blue-500 uppercase mb-1">${d.getMonth()+1}월 ${d.getDate()}일</div><div class="font-bold text-slate-700">${e.meetingType}: ${e.subject || '상세 일정'}</div></div>`;
            });
            const modalContent = document.getElementById('modalContent');
            if (modalContent) { modalContent.innerHTML = html; document.getElementById('modalOverlay')?.classList.remove('hidden'); }
        }

        function closeModal() { document.getElementById('modalOverlay')?.classList.add('hidden'); }

        function openYearMonthPicker() {
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth();
            let html = `<h3 class="text-xl font-black mb-6 text-slate-800 text-center">이동할 날짜 선택</h3>`;
            html += `<p class="text-[10px] font-bold text-gray-400 uppercase mb-2 ml-1">Year</p><div class="picker-grid mb-6">`;
            for(let i = y - 2; i <= y + 2; i++) { html += `<button class="picker-btn ${i === y ? 'active' : ''}" onclick="selectPickerDate(${i}, null)">${i}</button>`; }
            html += `</div><p class="text-[10px] font-bold text-gray-400 uppercase mb-2 ml-1">Month</p><div class="picker-grid">`;
            for(let i = 0; i < 12; i++) { html += `<button class="picker-btn ${i === m ? 'active' : ''}" onclick="selectPickerDate(${y}, ${i})">${i + 1}월</button>`; }
            html += `</div>`;
            const modalContent = document.getElementById('modalContent');
            if (modalContent) { modalContent.innerHTML = html; document.getElementById('modalOverlay')?.classList.remove('hidden'); }
        }

        window.selectPickerDate = (y, m) => {
            if (m === null) { currentDate.setFullYear(y); openYearMonthPicker(); } 
            else { currentDate = new Date(y, m, 1); closeModal(); fastRender(); onDayClick(y, m, 1); }
        };
    </script>
</body>
</html>
